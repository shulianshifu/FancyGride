Fancy.define("Fancy.grid.plugin.Expander",{extend:Fancy.Plugin,ptype:"grid.expander",inWidgetName:"expander",plusScroll:0,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a._expanded={},a._expandedIds={},a.expandedGroups={},a.initTpl(),a.ons()},ons:function(){var a=this,b=a.widget,c=b.store,d=b.expandRowCls;b.on("scroll",a.onScroll,a),b.on("beforesort",a.onBeforeSort,a),b.on("changepage",a.onChangePage,a),b.on("filter",a.onFilter,a),b.on("columnresize",a.onColumnReSize,a),b.on("rowdblclick",a.onRowDBlClick,a),b.on("rowtrackenter",a.onRowTrackOver,a),b.on("rowtrackleave",a.onRowTrackLeave,a),b.on("collapse",a.onGroupCollapse,a),b.on("expand",a.onGroupExpand,a),b.on("render",function(){b.el.on("mouseenter",a.onExpandRowMouseEnter,a,"div."+d),b.el.on("mouseleave",a.onExpandRowMouseLeave,a,"div."+d)}),b.on("select",a.onSelect,a),b.on("clearselect",a.onClearSelect,a),a.expanded&&(c.proxyType?b.once("load",function(){a.expandAll()}):b.on("init",function(){a.expandAll()}))},expand:function(a){var b=this,c=b.widget,d=c.cellCls,e=c.get(a).id;void 0===b._expandedIds[e]?(b._expandedIds[e]={},b.expandRow(Number(a),e),b.addMargin(Number(a)+1,e)):b.showRow(Number(a),e),delete b._expandedIds[e].hidden,b.reSetTop(),b.reSetPlusScroll();for(var f=c.el.select("."+c.columnCls+'[grid="'+c.id+'"] .'+d+'[index="'+a+'"] .fancy-checkbox-expander'),g=0,h=f.length;g<h;g++){var i=Fancy.getWidget(f.item(g).attr("id"));!1===i.get()&&i.set(!0,!1)}b.changeSidesSize(),b.onSelect()},collapse:function(a){var b=this,c=b.widget,d=c.scroller,e=c.get(a).id;b.collapseRow(Number(a),e),b.clearMargin(Number(a)+1,e),b.reSetTop(),b.reSetPlusScroll(),b.changeSidesSize(),d.scrollDelta(1),d.scrollRightKnob()},collapseRow:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b];e.el.hide(),e.hidden=!0,d.leftColumns&&e.leftEl.hide(),d.rightColumns&&e.rightEl.hide();for(var f=d.el.select("."+d.columnCls+'[grid="'+d.id+'"] .'+d.cellCls+'[index="'+a+'"] .fancy-checkbox-expander'),g=0,h=f.length;g<h;g++){var i=Fancy.getWidget(f.item(g).attr("id"));!0===i.get()&&(i.set(!1,!1),i.collapsedTime=new Date)}},_hideAllSideExpandedRow:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c];d.el.hide(),d.hidden=!0,b.leftColumns&&d.leftEl.hide(),b.rightColumns&&d.rightEl.hide()}},expandAll:function(){for(var a=this,b=a.widget,c=b.getViewTotal(),d=0;d<c;d++)a.expand(d)},expandRow:function(a,b){var c,d,e=this,f=e.widget,g=f.expandRowCls,h=Fancy.get(document.createElement("div")),i=f.getById(b),j=e.prepareData(i),k=-f.scroller.scrollLeft||0,l=f.getCenterFullWidth();if(e.tpl&&(c=e.tpl.getHTML(j),h.update(c)),h.addCls(g),h.css({left:k,width:l}),h.attr("index",a),f.body.el.dom.appendChild(h.dom),e.render&&e.render(h.dom,j,f.getCenterFullWidth()),d=parseInt(h.css("height")),e._expandedIds[b].rowIndex=a,e._expandedIds[b].el=h,e._expandedIds[b].height=d,e._expandedIds[b].width=l,f.leftColumns){var m=Fancy.get(document.createElement("div"));m.css("left","0px"),m.css("height",d),m.css("width",f.getLeftFullWidth()),m.attr("index",a),m.addCls(g),f.leftBody.el.dom.appendChild(m.dom),e._expandedIds[b].leftEl=m}if(f.rightColumns){var n=Fancy.get(document.createElement("div"));n.css("left","0px"),n.css("height",d),n.css("width",f.getRightFullWidth()),n.attr("index",a),n.addCls(g),f.rightBody.el.dom.appendChild(n.dom),e._expandedIds[b].rightEl=n}},addMargin:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b].height;d.el.select("."+d.columnCls+'[grid="'+d.id+'"] .'+d.cellCls+'[index="'+a+'"]').css("margin-top",e)},clearMargin:function(a,b){var c=this,d=c.widget;d.el.select("."+d.columnCls+'[grid="'+d.id+'"] .'+d.cellCls+'[index="'+a+'"]').css("margin-top","0")},onBeforeSort:function(){this.reSet()},onChangePage:function(){this.reSet()},onFilter:function(){this.reSet()},reSet:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c];d.el.destroy(),a.clearMargin(Number(d.rowIndex)+1,c)}a._hideAllSideExpandedRow(),a._expandedIds={},a.reSetTop(),a.reSetPlusScroll(),a.changeSidesSize(),b.scroller.scrollDelta(1)},showRow:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b];e.el.show(),d.leftColumns&&e.leftEl.show(),d.rightColumns&&e.rightEl.show(),c.addMargin(a+1,b)},getBeforeHeight:function(a){var b=this,c=0;for(var d in b._expandedIds){var e=b._expandedIds[d];e.rowIndex<a&&!e.hidden&&"none"!==e.el.css("display")&&(c+=e.height)}return c},reSetTop:function(a){var b=this,c=b.widget,d=c.cellHeight,e=-c.scroller.scrollTop||0,f=-c.scroller.scrollLeft||0;if(c.grouping){b.expandedGroups={};var g=c.grouping.expanded;for(var h in g)b.expandedGroups[h]=b.expandedGroups[h]||{}}for(var h in b._expandedIds){var i=b._expandedIds[h];if("none"!==i.el.css("display")){var j=b.getBeforeHeight(i.rowIndex),k=b.getDisplayedRowsBefore(i,h),l=e+k*d+j;if(c.grouping){var m=h,n=c.grouping.getGroupById(m),o=c.grouping.getGroupOrderIndex(n);"none"!==i.el.css("display")&&(b.expandedGroups[n]=b.expandedGroups[n]||{},b.expandedGroups[n][h]=i,l+=(o+1)*c.groupRowHeight)}i.el.css({top:l,left:f}),c.leftColumns&&i.leftEl.css("top",l),c.rightColumns&&i.rightEl.css("top",l)}}c.grouping&&!1!==a&&(c.grouping.setPositions(),c.grouping.setExpanderCellsPosition())},getDisplayedRowsBefore:function(a,b){var c=this,d=c.widget;if(d.grouping){var e=0;return"none"!==a.el.css("display")&&(e=d.store.getRow(b)),e+1}return a.rowIndex+1},onScroll:function(){this.reSetTop()},reSetPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.getPlusHeight(),b.scroller.setRightKnobSize(),setTimeout(function(){!1===b.scroller.isRightScrollable()&&b.scroller.scroll(0)},1)},getPlusHeight:function(){var a=this,b=0;for(var c in a._expandedIds){var d=a._expandedIds[c];d.hidden||"none"===d.el.css("display")||(b+=d.height)}return a.plusHeight=b,a.plusHeight},onColumnReSize:function(){var a=this,b=a.widget;for(var c in a._expandedIds){var d=a._expandedIds[c],e=b.getCenterFullWidth();d.el.css("width",e)}},prepareData:function(a){var b=this,c=b.widget,d=a.data;return b.dataFn&&(d=b.dataFn(c,d)),d},changeSidesSize:function(){var a=this.widget;a.setSidesHeight(),a.scroller.checkRightScroll()},onRowDBlClick:function(a,b){var c=this,d=c.widget,e=Number(b.rowIndex),f=b.id,g=c._expandedIds[f];if(d.edit)return void d.un("rowdblclick",c.onRowDBlClick,c);void 0===g?c.expand(e):!0===g.hidden&&"none"===g.el.css("display")?c.expand(e):c.collapse(e)},onRowTrackOver:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.addCls(d.expandRowOverCls),d.leftColumns&&e.leftEl.addCls(d.expandRowOverCls),d.rightColumns&&e.rightEl.addCls(d.expandRowOverCls))},onRowTrackLeave:function(a,b){var c=this,d=c.widget,e=c._expandedIds[b.id];e&&(e.el.removeCls(d.expandRowOverCls),d.leftColumns&&e.leftEl.removeCls(d.expandRowOverCls),d.rightColumns&&e.rightEl.removeCls(d.expandRowOverCls))},onExpandRowMouseEnter:function(a){var b=this,c=b.widget,d=c.scroller,e=Fancy.get(a.currentTarget),f=e.attr("index");c.el.select("."+c.expandRowCls+'[index="'+f+'"]').addCls(c.expandRowOverCls),!c.trackOver||d.bottomKnobDown||d.rightKnobDown||c.el.select("."+c.columnCls+'[grid="'+c.id+'"] .'+c.cellCls+'[index="'+f+'"]').addCls(c.rowOverCls)},onExpandRowMouseLeave:function(a){var b=this,c=b.widget,d=c.scroller,e=Fancy.get(a.currentTarget),f=e.attr("index");c.el.select("."+c.expandRowCls+'[index="'+f+'"]').removeCls(c.expandRowOverCls),!c.trackOver||d.bottomKnobDown||d.rightKnobDown||c.el.select("."+c.columnCls+'[grid="'+c.id+'"] .'+c.cellCls+'[index="'+f+'"]').removeCls(c.rowOverCls)},onSelect:function(){var a=this,b=a.widget,c=b.selection;if(c&&(c.row||c.rows)){a.onClearSelect(),c=b.getSelection(!0);for(var d=c.rows,e=0,f=d.length;e<f;e++){var g=d[e];b.el.select("."+b.expandRowCls+'[index="'+g+'"]').addCls(b.expandRowSelectedCls)}}},onClearSelect:function(){var a=this,b=a.widget,c=b.selection;if(c.row||c.rows){c=b.getSelection(!0);for(var d={},e=c.rows,f=0,g=e.length;f<g;f++)d[e[f]]=!0;for(var h=b.el.select("."+b.expandRowSelectedCls),f=0,g=h.length;f<g;f++){var i=h.item(f).attr("index");d[i]||b.el.select("."+b.expandRowCls+'[index="'+i+'"]').removeCls(b.expandRowSelectedCls)}}},onGroupCollapse:function(a,b,c){var d=this,e=d.widget,f=d.expandedGroups;if(f[c]){var g=f[c];for(var h in g){var i=g[h];d._expandedIds[h]&&delete d._expandedIds[h],i.el.hide(),i.leftEl.dom&&i.leftEl.hide(),i.rightEl.dom&&i.rightEl.hide()}}d.reSetTop(!1),d.reSetIndexes(),setTimeout(function(){e.grouping.setExpanderCellsPosition()},1)},onGroupExpand:function(a,b,c){var d=this,e=d.widget;d.reSetTop(!1),d.reSetIndexes(),setTimeout(function(){e.grouping.setExpanderCellsPosition()},1)},reSetIndexes:function(){var a=this,b=a.widget,c=b.store;for(var d in a._expandedIds)a._expandedIds[d].rowIndex=c.getRow(d)}});