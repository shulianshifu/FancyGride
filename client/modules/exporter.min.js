Fancy.modules.exporter=!0,Fancy.define("Fancy.grid.plugin.Exporter",{extend:Fancy.Plugin,ptype:"grid.exporter",inWidgetName:"exporter",csvSeparator:",",csvHeader:!1,csvFileName:"export",excelFileName:"export",constructor:function(){this.Super("const",arguments),Fancy.fullBuilt&&Fancy.loadModule("excel")},init:function(){},exportToExcel:function(a){function b(a){for(var b=new ArrayBuffer(a.length),c=new Uint8Array(b),d=0;d!=a.length;++d)c[d]=255&a.charCodeAt(d);return b}var c=this,d=c.widget,a=a||{},e=c.getColumnsData(a),f=c.getData(a),g=!1===a.header?f:[e].concat(f),h=function(){if(!(this instanceof h))return new h;this.SheetNames=[],this.Sheets={}},i=new h,j=c.sheet_from_array_of_arrays(g);j["!cols"]=[],Fancy.each(c.widths,function(a){j["!cols"].push({wch:a})});var k=d.title;a.fileName?k=a.fileName:Fancy.isObject(k)&&(k=k.text);var l=k||c.excelFileName;i.SheetNames.push(l),i.Sheets[l]=j;var m=XLSX.write(i,{bookType:"xlsx",bookSST:!0,type:"binary"});saveAs(new Blob([b(m)],{type:"application/octet-stream"}),l+".xlsx")},getColumnsData:function(a){var b,c=this,d=c.widget,e=[].concat(d.leftColumns).concat(d.columns).concat(d.rightColumns),f=[];return c.widths=[],a&&a.indexes&&(b={},Fancy.each(a.indexes,function(a){b[a]=!0})),Fancy.each(e,function(a){b&&!0!==b[a.index]||c.isColumnExportable(a)&&(c.widths.push(a.width),f.push(a.title||""))}),f},getData:function(a){if(a&&a.data)return a.data;var b=this,a=a||{},c=b.widget,d=[],e=a.all?c.getDisplayedData(!0,a.ignoreRender,a.rowIds,!0):c.getDisplayedData(null,a.ingoreRender,a.rowIds,!0);return Fancy.each(e,function(a){var b=[];Fancy.each(a,function(a){b.push(a)}),d.push(b)}),d},sheet_from_array_of_arrays:function(a,b){for(var c={},d={s:{c:1e7,r:1e7},e:{c:0,r:0}},e=0,f=a.length,g=function(a,b){return b&&(a+=1462),(Date.parse(a)-new Date(Date.UTC(1899,11,30)))/864e5};e!=f;++e)for(var h=0;h!=a[e].length;++h){d.s.r>e&&(d.s.r=e),d.s.c>h&&(d.s.c=h),d.e.r<e&&(d.e.r=e),d.e.c<h&&(d.e.c=h);var i={v:a[e][h]};if(null!=i.v){var j=XLSX.utils.encode_cell({c:h,r:e});"number"==typeof i.v?i.t="n":"boolean"==typeof i.v?i.t="b":i.v instanceof Date?(i.t="n",i.z=XLSX.SSF._table[14],i.v=g(i.v)):i.t="s",c[j]=i}}return d.s.c<1e7&&(c["!ref"]=XLSX.utils.encode_range(d)),c},getDataAsCsv:function(a){var b,c=this,d=c.widget,e=c.getData(a),f="",a=a||{},g=a.separator||c.csvSeparator,h=a.header||c.csvHeader;if(a&&a.indexes&&(b={},Fancy.each(a.indexes,function(a){b[a]=!0})),h){var i=function(a){b&&!0!==b[a.index]||c.isColumnExportable(a)&&(f+='"'+(a.title||"")+'"'+g)};Fancy.each(d.leftColumns,i),Fancy.each(d.columns,i),Fancy.each(d.rightColumns,i),f=f.substring(0,f.length-1),f+="\r\n"}return Fancy.each(e,function(a,b){Fancy.each(a,function(a,b){Fancy.isString(a)&&(a='"'+a+'"'),f+=a+g}),f=f.substring(0,f.length-1),f+="\r\n"}),f},exportToCSV:function(a){var b=this,a=a||{},c=b.getDataAsCsv(a),d=a.fileName||b.csvFileName,e=new Blob([c],{type:"text/csv;charset=utf-8;"});if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,d);else{var f=document.createElement("a");f.href=window.URL.createObjectURL(e),f.download=d+".csv",document.body.appendChild(f),f.click(),document.body.removeChild(f)}},isColumnExportable:function(a){if(/spark/.test(a.type))return!1;switch(a.type){case"select":case"action":case"expand":case"grossloss":case"hbar":case"rowdrag":return!1}return!a.hidden&&!1!==a.exportable}});