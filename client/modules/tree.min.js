Fancy.Mixin("Fancy.store.mixin.Tree",{initTreeData:function(){var a=this;if(a.isTree=!0,a.data&&0!==a.data.length){var b;b=Fancy.isObject(a.data)?a.treeReadData(a.data.items):a.treeReadData(a.data),a.setData(b)}else;},treeReadData:function(a,b,c){var d=this,e=[];return b=b||1,Fancy.each(a,function(a){a.data&&(a=a.data),a.$deep=b,a.leaf=!!a.leaf,a.expanded=!!a.expanded,a.child&&a.child.length&&(a.leaf=!1),c&&(a.parentId=c),a.id||(Fancy.idSeed++,a.id=Fancy.idSeed+1e3),e.push(a),a.expanded&&(e=e.concat(d.treeReadData(a.child||[],b+1,a.id)))}),e},treeGetDataAsTree:function(){var a=this,b=[];return Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a.data)}),b},treeSort:function(a,b,c,d){var e=this,f=[],g=[],h={},i=[];Fancy.each(a,function(a){f.push(a[c]),h[a[c]]=a});var j=!1,k=!1;if(f.length){j=!0,k=!0;var l;Fancy.each(a,function(a,b){""!==a[c]&&(j=!1),void 0!==l&&l!==a[c]&&(k=!1),l=a[c]})}if("number"===d)switch(b){case"asc":g=Fancy.Array.copy(f).sort(function(a,b){return a-b});break;case"desc":g=Fancy.Array.copy(f).sort(function(a,b){return b-a})}else switch(b){case"asc":g=Fancy.Array.copy(f).sort();break;case"desc":g=Fancy.Array.copy(f).sort(),g=g.reverse()}return Fancy.each(g,function(f,g){var l=h[f];(j||k)&&(l=a[g]),l.child&&l.expanded&&(l.sorted=e.treeSort(l.child,b,c,d)),i.push(l)}),i},treeReadSortedId:function(a){var b=this,c=[];return Fancy.each(a,function(a){c.push(a.id),a.sorted&&a.expanded&&(c=c.concat(b.treeReadSortedId(a.sorted)))}),c},treeReBuildData:function(){var a=this,b=[],c=[];Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a.data)}),c=a.treeReadData(b),a.setData(c)}}),function(){var a=function(b,c){return c=c||0,Fancy.each(b,function(b){c++,b.child&&b.expanded&&(c+=a(b.child))}),c};Fancy.define("Fancy.grid.plugin.Tree",{extend:Fancy.Plugin,ptype:"grid.tree",inWidgetName:"tree",singleExpand:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.once("init",function(){b.on("rowdblclick",a.onRowDBLClick,a),b.on("cellclick",a.onTreeExpanderClick,a),b.on("beforesort",a.onBeforeSort,a)})},onRowDBLClick:function(a,b){var c=this,d=c.widget,e=b.item;if(!(e.get("leaf")||d.edit&&2===d.edit.clicksToEdit)){e.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item)}},onTreeExpanderClick:function(a,b){var c=this,d=b.item;Fancy.get(b.e.target).hasClass("fancy-grid-tree-expander")&&!d.get("leaf")&&(d.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item))},collapseRow:function(b){var c=this,d=c.widget,e=d.store,f=b.get("child"),g=b.get("id"),h=b.get("parentId");if(b.set("expanded",!1),h){var i=d.getById(h),j=i.get("child");Fancy.each(j,function(a){a.id===g&&(a.expanded=!1)})}var k=e.getRow(b.get("id")),l=0,m=a(f);for(d.store.treeCollapsing=!0;l<m;l++)d.removeAt(k+1);delete d.store.treeCollapsing,f||d.update()},expandRow:function(a){var b=this,c=b.widget,d=c.store,e=a.get("child"),f=a.get("id"),g=a.get("parentId");if(b.singleExpand)if(g){var h=c.getById(g),i=h.get("child");Fancy.each(i,function(a){!0===a.expanded&&b.collapseRow(c.getById(a.id))})}else{var i=c.findItem("parentId","");Fancy.each(i,function(a){!0===a.get("expanded")&&b.collapseRow(a)})}if(g){var h=c.getById(g),i=h.get("child");Fancy.each(i,function(a){a.id===f&&(a.expanded=!0)})}a.set("expanded",!0);var j=d.getRow(a.get("id")),k=a.get("$deep")+1,l=function(a,b,d,e){return e=e||f,Fancy.each(a,function(a){a.$deep=d,a.parentId=e,b++,c.insert(b,a),!0===a.expanded&&(b=l(a.child,b,d+1,a.id))}),b};if(c.store.treeExpanding=!0,l(e,j,k),delete c.store.treeExpanding,e||c.update(),d.sorters){var m=d.sorters[0];d.sort(m.dir.toLocaleLowerCase(),m._type,m.key,{})}},onBeforeSort:function(a,b){var c=this;"drop"===b.action&&c.onDropSort()},onDropSort:function(){this.widget.store.treeReBuildData()}})}();