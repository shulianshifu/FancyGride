Fancy.Mixin("Fancy.store.mixin.Tree",{initTreeData:function(){var a=this;if(a.isTree=!0,a.data&&0!==a.data.length){var b;b=Fancy.isObject(a.data)?a.treeReadData(a.data.items):a.treeReadData(a.data),a.setData(b)}else;},treeReadData:function(a,b,c){var d=this,e=[];return b=b||1,Fancy.each(a,function(a){a.data&&(a=a.data),a.$deep=b,a.leaf=!!a.leaf,a.expanded=!!a.expanded,Fancy.isArray(a.filteredChild)&&a.filteredChild.length?a.leaf=!1:a.child&&a.child.length&&(a.leaf=!1),c&&(a.parentId=c),a.id||(Fancy.idSeed++,a.id=Fancy.idSeed+1e3),e.push(a),a.expanded&&(e=Fancy.isArray(a.filteredChild)?e.concat(d.treeReadData(a.filteredChild||[],b+1,a.id)):e.concat(d.treeReadData(a.child||[],b+1,a.id)))}),e},treeGetDataAsTree:function(){var a=this,b=[];return Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a)}),b},treeSort:function(a,b,c,d){var e=this,f=[],g=[],h={},i=[];Fancy.each(a,function(a){f.push(a.data[c]),h[a.data[c]]=a});var j=!1,k=!1;if(f.length){j=!0,k=!0;var l;Fancy.each(a,function(a,b){""!==a.data[c]&&(j=!1),void 0!==l&&l!==a.data[c]&&(k=!1),l=a.data[c]})}if("number"===d)switch(b){case"asc":g=Fancy.Array.copy(f).sort(function(a,b){return a-b});break;case"desc":g=Fancy.Array.copy(f).sort(function(a,b){return b-a})}else switch(b){case"asc":g=Fancy.Array.copy(f).sort();break;case"desc":g=Fancy.Array.copy(f).sort(),g=g.reverse()}return Fancy.each(g,function(f,g){var l=h[f];(j||k)&&(l=a[g]),l.data.child&&l.data.expanded&&(l.data.sorted=e.treeSort(l.data.child,b,c,d)),i.push(l)}),i},treeReadSortedId:function(a){var b=this,c=[];return Fancy.each(a,function(a){c.push(a.id),a=b.getById(a.id),a.data.expanded&&(a.data.sorted?c=c.concat(b.treeReadSortedId(a.data.sorted)):a.data.child&&(c=c.concat(b.treeReadSortedId(a.data.child))))}),c},treeReBuildData:function(){var a=this,b=[],c=[];Fancy.each(a.data,function(a){1===a.get("$deep")&&b.push(a.data)}),c=a.treeReadData(b),a.setData(c)}}),function(){var a=function(b,c){c=c||0;var d=this,e=d.widget;return Fancy.each(b,function(b){c++;var f=b.data?b.data:b;f=e.getById(f.id).data,f.child&&f.expanded&&(c+=a.apply(d,[f.child]))}),c};Fancy.define("Fancy.grid.plugin.Tree",{extend:Fancy.Plugin,ptype:"grid.tree",inWidgetName:"tree",singleExpand:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.expandMap={},a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.once("init",function(){b.on("rowdblclick",a.onRowDBLClick,a),b.on("cellclick",a.onTreeExpanderClick,a),b.on("beforesort",a.onBeforeSort,a)})},onRowDBLClick:function(a,b){var c=this,d=c.widget,e=b.item;if(!(e.get("leaf")||d.edit&&2===d.edit.clicksToEdit)){e.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item)}},onTreeExpanderClick:function(a,b){var c=this,d=b.item;Fancy.get(b.e.target).hasClass("fancy-grid-tree-expander")&&!d.get("leaf")&&(d.get("expanded")?c.collapseRow(b.item):c.expandRow(b.item))},collapseRow:function(b){var c=this,d=c.widget,e=d.store,f=b.get("child"),g=b.get("filteredChild"),h=b.get("id");c.expandMap[h]=!1,g&&(f=g),b.set("expanded",!1);var i=e.getRow(b.get("id")),j=0,k=a.apply(this,[f]);for(d.store.treeCollapsing=!0;j<k;j++)d.removeAt(i+1);delete d.store.treeCollapsing,d.update()},expandRow:function(a){var b=this,c=b.widget,d=c.store,e=a.get("child"),f=a.get("filteredChild"),g=a.get("id"),h=a.get("parentId");if(f&&(e=f),b.singleExpand)if(h){var i=c.getById(h),j=i.get("child");Fancy.each(j,function(a){var d=a.get("expanded");void 0!==b.expandMap[a.id]&&(d=b.expandMap[a.id]),!0===d&&b.collapseRow(c.getById(a.id))})}else{var j=c.findItem("parentId","");Fancy.each(j,function(a){var c=a.get("expanded");void 0!==b.expandMap[a.id]&&(c=b.expandMap[a.id]),!0===c&&b.collapseRow(a)})}b.expandMap[g]=!0,a.set("expanded",!0);var k=d.getRow(a.get("id")),l=a.get("$deep")+1,m=!1,n=function(a,d,e,f){return f=f||g,Fancy.each(a,function(a,g){var h=a.data;a.data||(m=!0,h=a),h.$deep=e,h.parentId=f;var i=h.expanded;if(void 0!==b.expandMap[h.id]&&(i=b.expandMap[h.id],h.expanded=i),d++,c.insert(d,h),!0===i){var j=h.child;h.filteredChild&&(j=h.filteredChild),d=n(j,d,e+1,h.id)}}),d};if(c.store.treeExpanding=!0,n(e,k,l),delete c.store.treeExpanding,m&&Fancy.each(a.data.child,function(b,c){var e=d.getById(b.id);void 0!==e&&(a.data.child[c]=e)}),c.update(),d.sorters){var o=d.sorters[0];d.sort(o.dir.toLocaleLowerCase(),o._type,o.key,{})}},onBeforeSort:function(a,b){var c=this;"drop"===b.action&&c.onDropSort()},onDropSort:function(){this.widget.store.treeReBuildData()}})}();