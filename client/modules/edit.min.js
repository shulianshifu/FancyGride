Fancy.define("Fancy.grid.plugin.Edit",{extend:Fancy.Plugin,ptype:"grid.edit",inWidgetName:"edit",clicksToEdit:2,tabColumnsSupport:{date:!0,combo:!0,image:!0,number:!0,string:!0,text:!0},constructor:function(a){this.Super("const",arguments)},init:function(){var a=this,b=a.widget,c=b.store;a.addEvents("tab"),a.Super("init",arguments),b.once("render",function(){a.ons(),c.on("beforeupdate",a.onStoreCRUDBeforeUpdate,a),c.on("update",a.onStoreCRUDUpdate,a),c.on("beforedestroy",a.onStoreCRUDBeforeDestroy,a),c.on("destroy",a.onStoreCRUDDestroy,a),c.on("create",a.onCreate,a)})},ons:function(){var a=this,b=a.widget,c=b.store,d="cell"+a.getClickEventName();b.on("cellclick",a.onClickCell,a),c.on("set",a.onStoreSet,a),a.on("tab",a.onTab,a),b.once("init",function(){b.on(d,a.onClickCellToEdit,a)}),b.on("activate",a.onGridActivate,a),b.on("deactivate",a.onGridDeActivate,a)},onGridActivate:function(){var a=this;Fancy.get(document).on("keydown",a.onKeyDown,a)},onGridDeActivate:function(){var a=this;Fancy.get(document).un("keydown",a.onKeyDown,a)},onKeyDown:function(a){var b=this,c=a.keyCode,d=Fancy.key;switch(c){case d.TAB:b.fire("tab",a)}},onTab:function(a,b){var a=this,c=a.widget;if(a.activeCellEditParams){b.preventDefault();var d=a.getNextCellEditParam();c.celledit&&(c.celledit.hideEditor(),!1!==c.tabEdit&&setTimeout(function(){c.celledit.edit(d)},100))}},getNextCellEditParam:function(){for(var a,b,c,d,e=this,f=e.widget,g=f.store,h=e.activeCellEditParams,i=f.leftColumns,j=h.columnIndex,k=h.rowIndex,l=h.side,m=f.getColumns(l),n=m[j+1],o=0,p=20;o<p;o++){var q=e.getNextCellInfo({side:l,columnIndex:j,rowIndex:k});if(l=q.side,j=q.columnIndex,k=q.rowIndex,m=f.getColumns(l),n=m[q.columnIndex],e.tabColumnsSupport[n.type]&&!0===n.editable)break}return a=f.getBody(l),b=a.getCell(k,j).dom,b||(l="center",i.length&&(l="left"),k=0,j=0,a=f.getBody(l),b=a.getCell(k,j).dom),c=n.index||n.key,d=g.getId(k),{id:g.getId(k),side:l,column:n,cell:b,columnIndex:j,rowIndex:k,value:g.get(k,c),data:g.get(k),item:g.getById(d)}},getNextCellInfo:function(a){var b=this,c=b.widget,d=a.side,e=c.getColumns(d),f=a.columnIndex,g=a.rowIndex,h=e[f+1],i=c.rightColumns,j=c.leftColumns;if(h)f++;else switch(d){case"left":d="center",f=0;break;case"center":i.length?(d="right",f=0):j.length?(d="left",f=0,g++):(f=0,g++);break;case"right":j.length?(d="left",f=0,g++):(d="center",f=0,g++)}return{side:d,rowIndex:g,columnIndex:f}},getClickEventName:function(){var a=this;return 1===a.clicksToEdit?"click":2===a.clicksToEdit?"dblclick":void 0},stopEditor:function(){this.stopped=!0},onClickCell:function(a,b){var c=this,d=c.widget,e=b.column;e.editable&&"checkbox"===e.type&&d.celledit&&d.celledit.onCheckBoxChange(b)},onClickCellToEdit:function(a,b){var c=this,d=c.widget,e=b.column;if(d.rowedit||d.celledit&&d.celledit.hideEditor(),c.fire("beforedit"),!0===c.stopped)return void(c.stopped=!1);d.rowedit?d.rowedit.edit(b):e.editable&&"checkbox"!==e.type&&d.celledit&&d.celledit.edit(b)},onStoreSet:function(a,b){this.widget.updater.updateRow(b.rowIndex)},onStoreCRUDBeforeUpdate:function(){var a=this,b=a.widget,c=a.activeCellEditParams;c&&b.updater.updateRow(c.rowIndex)},onStoreCRUDUpdate:function(a,b,c,d){delete a.changed[b],this.clearDirty()},onStoreCRUDBeforeDestroy:function(){},onStoreCRUDDestroy:function(){var a=this;a.widget.store.loadData(),a.clearDirty()},clearDirty:function(){var a=this.widget;setTimeout(function(){a.leftBody.clearDirty(),a.body.clearDirty(),a.rightBody.clearDirty()},500)},onCreate:function(a,b){var c=this;c.widget.updater.update(),c.clearDirty()}}),Fancy.define("Fancy.grid.plugin.CellEdit",{extend:Fancy.Plugin,ptype:"grid.celledit",inWidgetName:"celledit",editorsCls:"fancy-grid-editors",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.initEditorContainer(),a.checkAutoInitEditors(),b.on("scroll",a.onScroll,a),b.on("nativescroll",a.onNativeScroll,a),b.on("docclick",a.onDocClick,a),b.on("headercellmousedown",a.onHeaderCellMouseDown,a)})},onDocClick:function(a,b){var c=this,d=c.widget,e=c.activeCellEditParams,f=c.activeEditor,g=!0,h=b.target,i=Fancy.get(h);if(void 0!==f&&"date"!==e.column.type){if("combo"!==e.column.type){return void(i.closest("."+d.cellCls).dom||f.el.within(h)||f.hide())}!1===f.el.within(h)&&!1===f.list.within(h)&&!0!==c.comboClick&&(g=!1),!1===g&&f.hide(),c.comboClick=!1}},initEditorContainer:function(){var a=this,b=a.widget;a.editorsContainer=b.el.select("."+a.editorsCls)},edit:function(a){var b=this,c=b.widget,d=a.column;"$selected"!==d.index&&(b.activeCellEditParams=a,c.edit.activeCellEditParams=a,d.editor=b.generateEditor(d),c.scroller.scrollToCell(a.cell),b.showEditor(a))},generateEditor:function(a){var b,c,d=this,e=d.widget,f={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"},g=a.type,h=a.vtype,i=e.theme;if(a.editor)return a.editor;c=d.editorsContainer.dom;var j={renderTo:c,label:!1,style:f,checkValidOnTyping:!0};switch(g){case"combo":var k="text",l="text",m=a.data,n=[{change:d.onComboChange,scope:d}];if(a.editorEvents)for(var o=0,p=a.editorEvents.length;o<p;o++)n.push(a.editorEvents[o]);void 0!==a.displayKey&&(k=a.displayKey,l=k),"default"===i&&(i=void 0),b=new Fancy.Combo({theme:i,renderTo:c,label:!1,style:f,data:m,displayKey:k,valueKey:l,value:0,padding:!1,vtype:h,events:n,checkValidOnTyping:!0});break;case"text":b=new Fancy.TextArea({renderTo:c,label:!1,style:f,vtype:h,checkValidOnTyping:!0,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"image":case"string":case"color":b=new Fancy.StringField({renderTo:c,label:!1,style:f,vtype:h,format:a.format,checkValidOnTyping:!0,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"number":case"currency":Fancy.apply(j,{vtype:h,format:a.format,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]}),void 0!==a.spin&&(j.spin=a.spin),void 0!==a.step&&(j.step=a.step),void 0!==a.min&&(j.min=a.min),void 0!==a.max&&(j.max=a.max),b=new Fancy.NumberField(j);break;case"date":b=new Fancy.DateField({renderTo:c,label:!1,style:f,format:a.format,lang:e.lang,vtype:h,theme:i,checkValidOnTyping:!0,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;default:throw new Error("[FancyGrid error] - type "+g+" editor does not exit")}return b},showEditor:function(a){var b=this,c=b.widget,d=a.column,e=d.type,f=d.editor,g=a.cell,h=b.getCellPosition(g),i=b.getCellSize(g);"combo"===e&&(b.comboClick=!0),b.activeEditor=f,b.setEditorValue(a),b.setEditorSize(i),f.show(),f.el.css(h),f.focus(),"combo"===e&&void 0!==a.value&&f.set(a.value,!1),c.fire("startedit",a)},setEditorSize:function(a){var b=this;"field.combo"===b.activeEditor.wtype?b.activeEditor.size(a):b.activeEditor.setInputSize({width:a.width,height:a.height})},hideEditor:function(){var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=d.activeEditor;h&&(c=g.column,b=h.get(),"server"===f.proxyType&&"combo"!==c.type&&(a=d.getActiveColumnKey(),b=d.prepareValue(b),f.set(g.rowIndex,a,b)),h.hide(),h.hideErrorTip()),delete d.activeEditor,e.el.dom.scrollTop&&(e.el.dom.scrollTop=0)},getCellPosition:function(a){var b=this,c=b.widget,d=c.gridBorders,e=Fancy.get(a),f=e.offset(),g=c.el.offset();return{left:parseInt(f.left)-parseInt(g.left)-2+"px",top:parseInt(f.top)-parseInt(g.top)-(d[0]+d[2])+"px"}},getCellSize:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.width(),f=d.height(),g=2;return Fancy.nojQuery&&2===c.panelBorderWidth&&(g=1),e+=parseInt(d.css("border-right-width"))*g,f+=parseInt(d.css("border-bottom-width"))*g,{width:e,height:f}},setEditorValue:function(a){var b=this,c=b.activeEditor;switch(a.column.type){case"combo":-1!==c.valueIndex&&c.set(c.getValueKey(a.value),!1);break;case"date":var d=a.column.format,e=Fancy.Date.parse(a.value,d.read,d.mode);c.set(e);break;default:c.set(a.value)}},onEditorEnter:function(a,b){this.hideEditor()},onHeaderCellMouseDown:function(){this.hideEditor()},onKey:function(a,b){},setValue:function(a){var b,c=this,d=c.widget,e=d.store,f=c.activeCellEditParams,g=c.activeEditor;void 0!==g&&!1!==g.isValid()&&"server"!==e.proxyType&&(b=c.getActiveColumnKey(),a=c.prepareValue(a),"field.date"===g.type&&g.isEqual(e.get(f.rowIndex,b))||e.set(f.rowIndex,b,a))},onEditorBeforeHide:function(a){a.isValid()&&this.setValue(a.getValue())},onScroll:function(){this.hideEditor()},onNativeScroll:function(){this.hideEditor()},onBlur:function(a){var b=this;if(!b.activeEditor||a.id===b.activeEditor.id){if(!0===a.mouseDownSpinUp||a.mouseDownSpinDown)return;b.hideEditor()}},prepareValue:function(a){var b=this,c=b.getActiveColumnType(),d=b.activeCellEditParams,e=d.column,f=e.format;switch(c){case"number":case"currency":if(f&&f.inputFn){var g="",h=0,i=a.length;if(Fancy.isNumber(a))return a;for(;h<i;h++)isNaN(Number(a[h]))||(g+=a[h]);a=g}else""!==a&&(a=Number(a));break;case"date":if(e.format&&e.format.read){var j=e.editor.getDate();a=Fancy.Date.format(j,e.format.read,void 0,e.format.mode)}}return a},getActiveColumnType:function(){return this.activeCellEditParams.column.type},getActiveColumnKey:function(){var a=this,b=a.activeCellEditParams,c=b.column;return c.key||c.index},onCheckBoxChange:function(a){var b=this,c=b.widget,d=a.column,e=d.key||d.index,f=c.store,g=b.checkBoxChangedValue;b.activeEditor&&b.hideEditor(),void 0!==b.checkBoxChangedValue&&(delete b.checkBoxChangedValue,b.activeCellEditParams=a,c.edit.activeCellEditParams=a,f.set(a.rowIndex,e,g))},onComboChange:function(a,b){var c=this,d=c.widget,e=d.store,f=c.activeCellEditParams,g=c.getActiveColumnKey(),h=a.getDisplayValue(b);e.set(f.rowIndex,g,h),c.hideEditor()},checkAutoInitEditors:function(){var a=this,b=a.widget;Fancy.each(b.columns,function(b){b.editorAutoInit&&(b.editor=a.generateEditor(b))})}}),Fancy.define("Fancy.grid.plugin.RowEdit",{extend:Fancy.Plugin,ptype:"grid.rowedit",inWidgetName:"rowedit",rendered:!1,constructor:function(a){this.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a),b.grouping&&(b.on("collapse",a.onCollapse,a),b.on("expand",a.onExpand,a))},onCollapse:function(){this.hide()},onExpand:function(){this.hide()},edit:function(a){var b=this,c=b.widget;"$selected"!==a.column.index&&(c.scroller.scrollToCell(a.cell),b.showEditor(a))},showEditor:function(a){var b=this;if(b.changed={},b.rendered){var c="none"===b.el.css("display");b.show(),b.changePosition(a.rowIndex,!c)}else b.render(),b.changePosition(a.rowIndex,!1);b.setValues(a),b.setSizes()},render:function(){var a=this,b=a.widget;b.leftColumns&&(a.leftEl=a.renderTo(b.leftBody.el,b.leftColumns)),b.columns&&(a.el=a.renderTo(b.body.el,b.columns)),b.rightColumns&&(a.rightEl=a.renderTo(b.rightBody.el,b.rightColumns)),a.renderButtons(),a.rendered=!0},renderTo:function(a,b,c,d,e){var f,g,h,i,j=this,k=j.widget,l=Fancy.get(document.createElement("div")),m=0,n=b.length,o=k.theme,p={float:"left",margin:"0px",padding:"0px"};if(d){var q=a.select("."+Fancy.FIELD_CLS);switch(m=c,n=c+1,d){case"right":i=q.item(c);break;case"left":h=q.item(c);break;case"center":switch(e){case"left":i=q.item(0);break;case"right":h=q.item(q.length-1)}}}else l.addCls(k.rowEditCls),f=Fancy.get(a.dom.appendChild(l.dom));for(;m<n;m++){g=b[m];var r=g.width,s={index:g.index,label:!1,style:p,width:r,vtype:g.vtype,format:g.format,stopPropagation:!0,theme:o,checkValidOnTyping:!0,events:[{change:j.onFieldChange,delay:100,scope:j},{enter:j.onFieldEnter,scope:j}]};switch(d){case"left":s.renderAfter=h;break;case"right":s.renderBefore=i;break;case"center":switch(e){case"left":s.renderBefore=q.item(0);break;case"right":s.renderAfter=q.item(q.length-1)}break;default:s.renderTo=f.dom}var t;if(!1===g.editable)switch(g.type){case"string":case"number":t=new Fancy.TextField(s);break;default:t=new Fancy.EmptyField(s)}else switch(g.type){case"date":g.format&&(s.format=g.format),t=new Fancy.DateField(s);break;case"image":case"string":case"color":t=new Fancy.StringField(s);break;case"number":g.spin&&(s.spin=g.spin),g.step&&(s.step=g.step),g.min&&(s.min=g.min),g.max&&(s.max=g.max),t=new Fancy.NumberField(s);break;case"combo":Fancy.apply(s,{data:g.data,value:-1,padding:!1}),g.displayKey?(s.displayKey=g.displayKey,s.valueKey=g.displayKey):(s.displayKey="text",s.valueKey="text"),t=new Fancy.Combo(s);break;case"checkbox":var u;switch(g.cellAlign){case"left":u=7;break;case"center":u=(g.width-20-2)/2;break;case"right":u=(g.width-20)/2+11}Fancy.apply(s,{renderId:!0,value:!1,style:{padding:"0px",display:"inline-block","padding-left":u,float:"left",margin:"0px"}}),t=new Fancy.CheckBox(s);break;default:t=new Fancy.EmptyField(s)}g.rowEditor=t}return f},renderButtons:function(){var a,b=this,c=b.widget,d=Fancy.get(document.createElement("div"));d.addCls(c.rowEditButtonCls),a=Fancy.get(c.body.el.dom.appendChild(d.dom)),b.buttonsEl=a,b.buttonUpdate=new Fancy.Button({cls:"fancy-edit-row-button-update",renderTo:a.dom,text:"Update",events:[{click:b.onClickUpdate,scope:b}]}),b.buttonCancel=new Fancy.Button({cls:"fancy-edit-row-button-cancel",renderTo:a.dom,text:"Cancel",events:[{click:b.onClickCancel,scope:b}]})},setSizes:function(){var a=this,b=a.widget,c=b.cellCls;b.leftColumns&&a._setSizes(b.leftBody.el.select("."+c+'[index="0"]'),b.leftColumns,"left"),b.columns&&a._setSizes(b.body.el.select("."+c+'[index="0"]'),b.columns),b.rightColumns&&a._setSizes(b.rightBody.el.select("."+c+'[index="0"]'),b.rightColumns,"right"),a.setElSize()},setElSize:function(){var a=this,b=a.widget,c=b.getCenterViewWidth(),d=b.getCenterFullWidth();c<d&&a.el.css("width",d)},_setSizes:function(a,b,c){for(var d,e,f,g,h=this,i=0,j=b.length,k=1,l=2;i<j;i++)d=b[i],f=a.item(i).dom,Fancy.get(f),e=h.getCellSize(f),(g=d.rowEditor)&&("left"!==c&&"right"!==c||i!==j-1||e.width--,e.height-=2,i===j-1?g.el.css("width",e.width-2):g.el.css("width",e.width-1),g.el.css("height",e.height),e.width-=2*k,e.width-=2*l,e.height-=2*l,h.setEditorSize(g,e))},getCellSize:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.width(),f=d.height(),g=2;return Fancy.nojQuery&&2===c.panelBorderWidth&&(g=1),e+=parseInt(d.css("border-right-width"))*g,f+=parseInt(d.css("border-bottom-width"))*g,{width:e,height:f}},setEditorSize:function(a,b){"field.combo"===a.wtype?(a.size(b),a.el.css("width",b.width+5)):a.setInputSize({width:b.width,height:b.height})},changePosition:function(a,b){var c=this,d=c.widget,e=d.scroller.getScroll(),f=d.scroller.getBottomScroll(),g=d.cellHeight*a-1-e,h=100,i=0;d.grouping&&(i+=d.grouping.getOffsetForRow(a),g+=i),c.leftEl&&(!1!==b?c.leftEl.animate({duration:h,top:g}):c.leftEl.css("top",g)),c.el&&(!1!==b?c.el.animate({duration:h,top:g}):c.el.css("top",g)),c.rightEl&&(!1!==b?c.rightEl.animate({duration:h,top:g}):c.rightEl.css("top",g));var j=d.getViewTotal()-3<a,k=g;a<3&&(j=!1),j?d.grouping?d.getViewTotal()-3<a-d.grouping.getSpecialRowsUnder(a)?k=g-parseInt(c.buttonsEl.css("height"))+1:(k=g+d.cellHeight,j=!1):k=g-parseInt(c.buttonsEl.css("height"))+1:k=g+d.cellHeight,!1!==b?c.buttonsEl.animate({duration:h,top:k}):c.buttonsEl.css("top",k),c.el.css("left",-f),c.changeButtonsLeftPos(),c.activeRowIndex=a},changeButtonsLeftPos:function(){var a=this,b=a.widget,c=b.getCenterViewWidth(),d=parseInt(a.buttonsEl.css("width"));a.buttonsEl.css("left",(c-d)/2)},setValues:function(a){var b=this,c=b.widget;c.leftColumns&&b._setValues(a.data,c.leftColumns),c.columns&&b._setValues(a.data,c.columns),c.rightColumns&&b._setValues(a.data,c.rightColumns),b.activeId=a.id,b.activeRowIndex=a.rowIndex},_setValues:function(a,b){Fancy.each(b,function(b){var c=b.rowEditor;if(c)switch(b.type){case"action":case"button":case"order":case"select":break;default:c.set(a[b.index],!1)}})},onScroll:function(){var a=this;!1!==a.rendered&&void 0!==a.activeRowIndex&&a.changePosition(a.activeRowIndex,!1)},onColumnResize:function(){var a=this;!1!==a.rendered&&a.setSizes()},onClickUpdate:function(){var a=this,b=a.widget,c=b.store,d=a.prepareChanged(),e=c.getRow(a.activeId);c.setItemData(e,d),b.update(),a.hide()},prepareChanged:function(){var a=this,b=a.widget,c=a.changed;for(var d in c){var e=b.getColumnByIndex(d);switch(e.type){case"date":var f=Fancy.Date.parse(c[d],e.format.edit,e.format.mode),g=Fancy.Date.format(f,e.format.read,e.format.mode);c[d]=g}}return c},onClickCancel:function(){this.hide()},hide:function(){var a=this;a.el&&(a.leftEl&&a.leftEl.hide(),a.el.hide(),a.rightEl&&a.rightEl.hide(),a.buttonsEl.hide())},show:function(){var a=this;a.leftEl&&a.leftEl.show(),a.el.show(),a.rightEl&&a.rightEl.show(),a.buttonsEl.show()},onFieldChange:function(a,b,c){var d=this;a.isValid()?d.changed[a.index]=b:delete d.changed[a.index]},onFieldEnter:function(){var a=this,b=a.widget,c=b.store,d=c.getRow(a.activeId);c.setItemData(d,a.changed),b.update(),a.hide()},hideField:function(a,b){var c=this,d=c.widget,e=d.getColumns(b),f=e[a];f.rowEditor&&f.rowEditor.hide()},showField:function(a,b){var c=this,d=c.widget,e=d.getColumns(b),f=e[a];f.rowEditor&&f.rowEditor.show()},moveEditor:function(a,b,c,d){var e,f=this,g=f.widget,h=g.store,i=g.getColumns(c),j=a.rowEditor,k=g.getBody(c),l=k.el.select("."+g.rowEditCls),m=h.getById(f.activeId),n=m.get(a.index);void 0===f.activeId&&(n=h.get(f.activeRowIndex)[a.index]),j.destroy(),f.renderTo(l,i,b,c,d),e=f.getField(b,c),a.rowEditor=e,e.set(n),f.setSizes(),f.changeButtonsLeftPos(),f.reSetColumnsEditorsLinks()},getField:function(a,b){var c=this,d=c.widget,e=d.getBody(b);switch(b){case"left":a++}return Fancy.getWidget(e.el.select("."+Fancy.FIELD_CLS).item(a).attr("id"))},reSetColumnsEditorsLinks:function(){var a,b=this,c=b.widget,d=Fancy.FIELD_CLS;a=c.body.el.select("."+d),Fancy.each(c.columns,function(b,c){b.rowEditor=Fancy.getWidget(a.item(c).attr("id"))}),a=c.leftBody.el.select("."+d),Fancy.each(c.leftColumns,function(b,c){b.rowEditor=Fancy.getWidget(a.item(c).attr("id"))}),a=c.rightBody.el.select("."+d),Fancy.each(c.rightColumns,function(b,c){b.rowEditor=Fancy.getWidget(a.item(c).attr("id"))})}});