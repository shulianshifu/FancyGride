Fancy.Mixin("Fancy.store.mixin.Edit",{idSeed:0,remove:function(a){var b,c,d,e=this,f=(e.getTotal(),a.id);switch(Fancy.typeOf(a)){case"string":case"number":f=a;break;default:f=a.id||a.data.id}return"server"===e.proxyType&&e.autoSave?void e.proxyCRUD("DESTROY",f):(a.rowIndex?(b=e.dataViewIndexes[a.rowIndex],c=a.rowIndex):(b=e.getDataIndex(f),c=e.getRow(f)),d=e.data.splice(b,1)[0],e.paging&&(c+=e.showPage*e.pageSize),e.order&&e.order.splice(c,1),e.changeOrderIndexes&&e.changeOrderIndexes(b),e.paging&&(0!==e.showPage&&e.showPage*e.pageSize===e.getTotal()&&e.showPage--,e.calcPages()),e.fire("remove",f,d),void e.changeDataView())},removeAt:function(a){var b=this;b.remove({rowIndex:a,id:b.getId(a)})},add:function(a){var b=this;b.model;return b.insert(b.getTotal(),a)},insert:function(a,b){var c=this;c.model;return c.addIndex=a,void 0===b.id&&(c.idSeed++,"server"===c.proxyType?b.id="Temp-"+c.idSeed:b.id=c.getTotal()+c.idSeed),"server"===c.proxyType&&c.autoSave?(c.once("create",c.onCreate,c),void c.proxyCRUD("CREATE",b)):c.insertItem(b,a)},insertItem:function(a){var b=this,c=b.model,d=new c(a),e=b.addIndex;return delete b.addIndex,d.$index=e,b.data.splice(e,0,d),b.order&&(b.order.splice(e,0,e),b.changeOrderIndexes(e,"+"),b.order[e]--),b.changeDataView(),b.map[a.id]=d,b.fire("insert",d),d},onCreate:function(a,b){return this.insertItem(b)}}),function(){Fancy.vtypes={},Fancy.addValid=function(a,b){Fancy.vtypes[a]=b},Fancy.isValid=function(a,b){var c;if(Fancy.isString(a)?c=Fancy.vtypes[a]:Fancy.isObject(a)&&(a.type?(c=Fancy.vtypes[a.type],Fancy.applyIf(a,c)):c=a),c.before){var d=c.before,e=[a];Fancy.isString(d)?e.push(d):Fancy.isArray(d)&&(e=e.concat(d)),e.reverse();for(var f=0,g=e.length;g>f;f++)if(c=Fancy.isObject(e[f])?e[f]:Fancy.vtypes[e[f]],c.re){if(c.re.test(b)===!1)return c}else if(c.fn&&c.fn.apply(c,[b])===!1)return c}else{if(c.re&&c.re.test(b)===!1)return c;if(c.fn.apply(c,[b])===!1)return c}return!0}}(),Fancy.addValid("notempty",{text:"Must be present",fn:function(a){return null===a||void 0===a?!1:0!==String(a).length}}),Fancy.addValid("notnan",{text:"Must be numeric",fn:function(a){return!isNaN(a)}}),Fancy.addValid("min",{before:["notempty","notnan"],text:"Must be must be at least {param}",fn:function(a){return a>this.param}}),Fancy.addValid("max",{before:["notempty","notnan"],text:"Must be no more than {param}",fn:function(a){return a<this.param}}),Fancy.addValid("range",{before:["notempty","notnan"],text:"Must be between {min} and {max}",fn:function(a){return a>=this.min&&a<=this.max}}),Fancy.addValid("email",{before:"notempty",re:/^(")?(?:[^\."])(?:(?:[\.])?(?:[\w\-!#$%&'*+\/=?\^_`{|}~]))*\1@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/,text:"Is not a valid email address"}),Fancy.Mixin("Fancy.grid.mixin.Edit",{remove:function(a,b){var c=this,d=c.store,e="remove";if(b&&(e="removeAt"),Fancy.isArray(a))for(var f=0,g=a.length;g>f;f++)d[e](a[f]);else d[e](a);c.setSidesHeight()},removeAt:function(a){var b=this;b.remove(a,!0)},add:function(a){this.store.add(a)},insert:function(a,b){var c=this,d=c.store;Fancy.isObject(a)&&void 0===b&&(b=a,a=0),c.paging&&"server"!==d.proxyType&&(a+=d.showPage*d.pageSize),d.insert(a,b),c.setSidesHeight()},set:function(a,b,c){var d=this,e=d.store;Fancy.isObject(b)&&void 0===c?e.setItemData(a,b,c):e.set(a,b,c)}}),Fancy.define("Fancy.grid.plugin.Edit",{extend:Fancy.Plugin,ptype:"grid.edit",inWidgetName:"edit",clicksToEdit:2,tabColumnsSupport:{date:!0,combo:!0,image:!0,number:!0,string:!0,text:!0},constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this,b=a.widget,c=b.store;a.addEvents("tab"),a.Super("init",arguments),b.once("render",function(){a.ons(),c.on("beforeupdate",a.onStoreCRUDBeforeUpdate,a),c.on("update",a.onStoreCRUDUpdate,a),c.on("beforedestroy",a.onStoreCRUDBeforeDestroy,a),c.on("destroy",a.onStoreCRUDDestroy,a),c.on("create",a.onCreate,a)})},ons:function(){var a=this,b=a.widget,c=b.store,d="cell"+a.getClickEventName();b.on("cellclick",a.onClickCell,a),b.on(d,a.onClickCellToEdit,a),c.on("set",a.onStoreSet,a),b.el.on("keydown",a.onKeyDown,a),a.on("tab",a.onTab,a)},onKeyDown:function(a){var b=this,c=a.keyCode,d=Fancy.key;switch(c){case d.TAB:b.fire("tab",a)}},onTab:function(a,b){var a=this,c=a.widget,d=a.activeCellEditParams;if(d){b.preventDefault();var e=a.getNextCellEditParam();c.celledit.hideEditor(),setTimeout(function(){c.celledit.edit(e)},100)}},getNextCellEditParam:function(){for(var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=(e.rightColumns,e.leftColumns),i=g.columnIndex,j=g.rowIndex,k=g.side,l=e.getBody(k),m=e.getColumns(k),n=m[i+1],o=0,p=20;p>o;o++){var q=d.getNextCellInfo({side:k,columnIndex:i,rowIndex:j});if(k=q.side,i=q.columnIndex,j=q.rowIndex,m=e.getColumns(k),n=m[q.columnIndex],d.tabColumnsSupport[n.type])break}return l=e.getBody(k),a=l.getCell(j,i).dom,a||(k="center",h.length&&(k="left"),j=0,i=0,l=e.getBody(k),a=l.getCell(j,i).dom),b=n.index||n.key,c=f.getId(j),{id:f.getId(j),side:k,column:n,cell:a,columnIndex:i,rowIndex:j,value:f.get(j,b),data:f.get(j),item:f.getById(c)}},getNextCellInfo:function(a){var b=this,c=b.widget,d=a.side,e=c.getColumns(d),f=a.columnIndex,g=a.rowIndex,h=e[f+1],i=c.rightColumns,j=c.leftColumns;if(h)f++;else switch(d){case"left":d="center",f=0;break;case"center":i.length?(d="right",f=0):j.length?(d="left",f=0,g++):(f=0,g++);break;case"right":j.length?(d="left",f=0,g++):(d="center",f=0,g++)}return{side:d,rowIndex:g,columnIndex:f}},getClickEventName:function(){var a=this;return 1===a.clicksToEdit?"click":2===a.clicksToEdit?"dblclick":void 0},stopEditor:function(){var a=this;a.stopped=!0},onClickCell:function(a,b){var c=this,d=c.widget,e=b.column;e.type;e.editable&&"checkbox"===e.type&&d.celledit.onCheckBoxChange(b)},onClickCellToEdit:function(a,b){var c=this,d=c.widget,e=b.column;e.type;return d.celledit.hideEditor(),c.stopped===!0?void(c.stopped=!1):void(e.editable&&"checkbox"!==e.type&&d.celledit.edit(b))},onStoreSet:function(a,b){var c=this,d=c.widget;d.updater.updateRow(b.rowIndex)},onStoreCRUDBeforeUpdate:function(){var a=this,b=a.widget,c=a.activeCellEditParams,d=Fancy.get(c.cell);d=Fancy.get(c.cell),b.updater.updateRow(c.rowIndex),d.hasClass("fancy-grid-cell-dirty")===!1},onStoreCRUDUpdate:function(){var a=this,b=(a.widget,a.activeCellEditParams);Fancy.get(b.cell);a.clearDirty()},onStoreCRUDBeforeDestroy:function(){},onStoreCRUDDestroy:function(){var a=this,b=a.widget,c=b.store;c.loadData(),a.clearDirty()},clearDirty:function(){var a=this,b=a.widget;b.store;setTimeout(function(){b.leftBody.clearDirty(),b.body.clearDirty(),b.rightBody.clearDirty()},500)},onCreate:function(a,b){var c=this,d=c.widget;d.store;d.updater.update(),c.clearDirty()}}),Fancy.define("Fancy.grid.plugin.CellEdit",{extend:Fancy.Plugin,ptype:"grid.celledit",inWidgetName:"celledit",constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.initEditorContainer(),a.initDirtyMap(),b.on("scroll",a.onScroll,a),b.on("docclick",a.onDocClick,a),b.on("headercellmousedown",a.onHeaderCellMouseDown,a)})},onDocClick:function(a,b){var c=this,d=c.activeCellEditParams,e=c.activeEditor,f=!0;if(void 0!==e&&"combo"===d.column.type){var g=b.target;e.el.within(g)===!1&&e.list.within(g)===!1&&c.comboClick!==!0&&(f=!1),f===!1&&e.hide(),c.comboClick=!1}},initEditorContainer:function(){var a=this,b=a.widget;a.editorsContainer=b.el.select(".fancy-grid-editors")},edit:function(a){var b=this,c=b.widget,d=a.column;d.type;b.activeCellEditParams=a,c.edit.activeCellEditParams=a,d.editor=b.generateEditor(d),c.scroller.scrollToCell(a.cell),b.showEditor(a)},generateEditor:function(a){var b,c,d=this,e=d.widget,f={position:"absolute",left:"0px",top:"0px",display:"none",padding:"0px"},g=a.type,h=a.vtype,i=e.theme;if(a.editor)return a.editor;switch(c=d.editorsContainer.dom,g){case"combo":var j=d.configComboData(a.data);"default"===i&&(i=void 0),b=new Fancy.Combo({theme:i,renderTo:c,label:!1,style:f,data:j,displayKey:"valueText",valueKey:"index",value:0,padding:!1,vtype:h,events:[{change:d.onComboChange,scope:d}]});break;case"text":b=new Fancy.TextArea({renderTo:c,label:!1,style:f,vtype:h,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"image":case"string":b=new Fancy.StringField({renderTo:c,label:!1,style:f,vtype:h,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"number":case"currency":b=new Fancy.NumberField({renderTo:c,label:!1,style:f,vtype:h,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;case"date":b=new Fancy.DateField({renderTo:c,label:!1,style:f,format:a.format,lang:e.lang,vtype:h,theme:i,events:[{enter:d.onEditorEnter,scope:d},{beforehide:d.onEditorBeforeHide,scope:d},{blur:d.onBlur,scope:d}]});break;default:throw new Error("[FancyGrid error] - type "+g+" editor does not exit")}return b},configComboData:function(a){var b=0,c=a.length,d=[];if(Fancy.isObject(a))return a;for(;c>b;b++)d.push({index:b,valueText:a[b]});return d},showEditor:function(a){var b=this,c=(b.widget,a.column),d=c.type,e=c.editor,f=a.cell,g=b.getCellPosition(f),h=b.getCellSize(f);"combo"===d&&(b.comboClick=!0),b.activeEditor=e,b.setEditorValue(a),b.setEditorSize(h),e.show(),e.el.css(g),"combo"!==d&&e.focus()},setEditorSize:function(a){var b=this;"field.combo"===b.activeEditor.wtype?b.activeEditor.size(a):b.activeEditor.setInputSize({width:a.width,height:a.height})},hideEditor:function(){var a,b,c,d=this,e=d.widget,f=e.store,g=d.activeCellEditParams,h=d.activeEditor;h&&(c=g.column,b=h.get(),"server"===f.proxyType&&"combo"!==c.type&&(a=d.getActiveColumnKey(),b=d.prepareValue(b),f.set(g.rowIndex,a,b)),h.hide(),h.hideErrorTip()),delete d.activeEditor},getCellPosition:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.offset(),f=c.el.offset(),g={left:parseInt(e.left)-parseInt(f.left)-2+"px",top:parseInt(e.top)-parseInt(f.top)-2+"px"};return g},getCellSize:function(a){var b=this,c=b.widget,d=Fancy.get(a),e=d.width(),f=d.height(),g=2;return Fancy.nojQuery&&2===c.panelBorderWidth&&(g=1),e+=parseInt(d.css("border-right-width"))*g,f+=parseInt(d.css("border-bottom-width"))*g,{width:e,height:f}},setEditorValue:function(a){var b=this,c=b.widget,d=(c.lang,b.activeEditor);switch(a.column.type){case"combo":d.set(d.getValueKey(a.value),!1);break;case"date":var e=a.column.format,f=Fancy.Date.parse(a.value,e.read),g=Fancy.Date.format(f,e.edit);d.set(g);break;default:d.set(a.value)}},onEditorEnter:function(a,b){var c=this;c.hideEditor()},onHeaderCellMouseDown:function(){var a=this;a.hideEditor()},onKey:function(a,b){setTimeout(function(){},1)},setValue:function(a){var b,c=this,d=c.widget,e=d.store,f=c.activeCellEditParams,g=c.activeEditor;f.column;void 0!==g&&g.isValid()!==!1&&"server"!==e.proxyType&&(b=c.getActiveColumnKey(),a=c.prepareValue(a),e.set(f.rowIndex,b,a))},onEditorBeforeHide:function(a){var b=this;b.setValue(a.getValue())},onScroll:function(){var a=this;a.hideEditor()},onBlur:function(a){var b=this;b.activeEditor&&a.id!==b.activeEditor.id||b.hideEditor()},prepareValue:function(a){var b=this,c=b.getActiveColumnType();return"number"!==c&&"currency"!==c||""===a||(a=Number(a)),a},getActiveColumnType:function(){var a=this,b=a.activeCellEditParams,c=b.column;return c.type},getActiveColumnKey:function(){var a=this,b=a.activeCellEditParams,c=b.column,d=c.key||c.index;return d},initDirtyMap:function(){},onCheckBoxChange:function(a){var b=this,c=b.widget,d=a.column,e=d.key||d.index,f=c.store,g=b.checkBoxChangedValue;b.activeEditor&&b.hideEditor(),void 0!==b.checkBoxChangedValue&&(delete b.checkBoxChangedValue,b.activeCellEditParams=a,c.edit.activeCellEditParams=a,f.set(a.rowIndex,e,g))},onComboChange:function(a,b){var c=this,d=c.widget,e=d.store,f=c.activeEditor,g=c.activeCellEditParams,h=c.getActiveColumnKey();b=f.getDisplayValue(b),e.set(g.rowIndex,h,b),c.hideEditor()}}),Fancy.define("Fancy.grid.plugin.RowEdit",{extend:Fancy.Plugin,ptype:"grid.rowedit",inWidgetName:"rowedit",constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store}});