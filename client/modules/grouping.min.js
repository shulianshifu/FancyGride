Fancy.Mixin("Fancy.store.mixin.Grouping",{expand:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.filteredData&&(d=c.filteredData,f=d.length),c.expanded=c.expanded||{},c.expanded[b]=!0;f>e;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},collapse:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.expanded=c.expanded||{},delete c.expanded[b];f>e;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},changeOrderByGroups:function(a,b){for(var c,d=this,e={},f=0,g=a.length,h=[];g>f;f++)e[a[f]]=[];for(f=0,g=d.data.length;g>f;f++){c=d.data[f];var i=c.data[b];e[i].push(c)}for(f=0,g=a.length;g>f;f++)h=h.concat(e[a[f]]);d.grouping={by:b},d.data=h},getColumnOriginalValuesByGroup:function(a,b){for(var c=this,d=c.data,e=0,f=d.length,g=[],h=[],i=d[0].data[b];f>e;e++)d[e].data[b]===i?h.push(d[e].data[a]):(g.push({values:h,groupName:i}),h=[],i=d[e].data[b],e--);return f>0&&g.push({values:h,groupName:i}),g}}),Fancy.define("Fancy.grid.plugin.Grouping",{extend:Fancy.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}:{number}",_renderFirstTime:!0,constructor:function(a){var b=this;b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a._expanded={},a.initTpl(),a.initGroups(),a.initOrder(),a.calcPlusScroll(),a.configParams(),a.ons()},initTpl:function(){var a=this;a.tpl&&(a.tpl=new Fancy.Template(a.tpl))},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.renderGroupedRows(),a.update(),b.el.on("click",a.onClick,a,"div."+b.clsGroupRow),b.el.on("mousedown",a.onMouseDown,a,"div."+b.clsGroupRow),b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a)})},initGroups:function(a){var b=this,c=b.widget,d=c.store,a=a||"data";if(!b.by)throw new Error("[FancyGrid Error] - not set by param in grouping");for(var e=d.getColumnOriginalValues(b.by,{dataProperty:a}),f={},g=0,h=e.length;h>g;g++)void 0===f[e[g]]&&(f[e[g]]=0),f[e[g]]++;var i=[];for(var j in f)i.push(j);b.groups=i,b.groupsCounts=f},initOrder:function(){var a,b,c=this,d=c.widget,e=d.store,f=[],g={},h=[];if(c.order&&0!==c.order.length)switch(Fancy.typeOf(c.order)){case"string":break;case"array":f=c.groups}else{for(f=c.groups,a=0,b=f.length;b>a;a++){var i=f[a].toLocaleUpperCase();g[i]=f[a],h.push(i)}for(h=h.sort(),a=0;b>a;a++)f[a]=g[h[a]]}c.groups=f,e.changeOrderByGroups(f,c.by)},calcPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.groups.length*b.groupRowHeight},configParams:function(){var a,b,c=this,d=c.widget,e=d.store;if(c.expanded=c.expanded||{},e.expanded=e.expanded||{},c.collapsed)e.collapsed=!0;else for(a=0,b=c.groups.length;b>a;a++)void 0===c.expanded[c.groups[a]]&&(e.expanded[c.groups[a]]=!0,c.expanded[c.groups[a]]=!0,c._expanded[c.groups[a]]=!0)},renderGroupedRows:function(){var a,b,c=this,d=c.widget,e=d.columns,f=d.leftColumns,g=d.rightColumns,h=(d.store,d.body),i=d.leftBody,j=d.rightBody,k=0,l=0,m=0,n=0;for(a=e.length;a>k;k++)e[k].hidden||(l+=e[k].width);for(k=0,a=f.length;a>k;k++)f[k].hidden||(m+=f[k].width);for(k=0,a=g.length;a>k;k++)g[k].hidden||(n+=g[k].width);k=0,a=c.groups.length;for(var o=0;a>k;k++){var p=c.groups[k],q=c.groupsCounts[p];m?(b=c.generateGroupRow(p,q,!0,o),b.css("width",m),i.el.dom.appendChild(b.dom),b=c.generateGroupRow(p,q,!1,o),b.css("width",l),h.el.dom.appendChild(b.dom)):(b=c.generateGroupRow(p,q,!0,o),b.css("width",l),h.el.dom.appendChild(b.dom)),n&&(b=c.generateGroupRow(p,q,!1,o),b.css("width",n),j.el.dom.appendChild(b.dom)),c.collapsed&&(o+=d.groupRowHeight)}},removeGroupRows:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=(b.store,b.body),g=b.leftBody,h=b.rightBody;c.length&&f.el.select(".fancy-grid-group-row").remove(),d.length&&g.el.select(".fancy-grid-group-row").remove(),e.length&&h.el.select(".fancy-grid-group-row").remove()},removeCells:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=(b.store,b.body),g=b.leftBody,h=b.rightBody;c.length&&f.el.select(".fancy-grid-cell").remove(),d.length&&g.el.select(".fancy-grid-cell").remove(),e.length&&h.el.select(".fancy-grid-cell").remove()},generateGroupRow:function(a,b,c,d){var e=this,f=e.widget,g=f.clsGroupRow,h=Fancy.get(document.createElement("div"));if(h.addClass(g),h.attr("group",a),c){var i=e.tpl.getHTML({text:a,number:b});h.update('<div class="fancy-grid-group-row-inner"> '+i+"</div>")}return e.collapsed?(h.css("top",d+"px"),h.addClass(f.clsCollapsedRow)):h.css("top","0px"),h},onClick:function(a){var b,c=this,d=c.widget,e=d.clsCollapsedRow,f=Fancy.get(a.currentTarget),g=f.attr("group");d.el.select("."+d.clsGroupRow+'[group="'+g+'"]').toggleClass(e),b=f.hasClass(e),b?c.collapse(c.by,g):c.expand(c.by,g),c.update()},fastCollapse:function(){},onMouseDown:function(a){a.preventDefault()},onScroll:function(){var a=this;a.widget;a.setPositions()},collapse:function(a,b){var c=this,d=c.widget,e=d.store;e.collapse(a,b),delete c._expanded[b],delete c.expanded[b],d.fire("collapse",a,b)},expand:function(a,b){var c=this,d=c.widget,e=d.store;e.expand(a,b),c._expanded[b]=!0,c.expanded[b]=!0,d.fire("expand",a,b)},setPositions:function(){for(var a=this,b=a.widget,c=0,d=a.groups.length,e=-b.scroller.scrollTop||0,f=(b.clsGroupRow,b.leftBody.el.select("."+b.clsGroupRow)),g=b.body.el.select("."+b.clsGroupRow),h=b.rightBody.el.select("."+b.clsGroupRow);d>c;c++){var i=a.groups[c];f.length&&f.item(c).css("top",e+"px"),g.length&&g.item(c).css("top",e+"px"),h.length&&h.item(c).css("top",e+"px"),e+=b.groupRowHeight,a._expanded[i]===!0&&(e+=a.groupsCounts[i]*b.cellHeight)}},setCellsPosition:function(){for(var a,b,c=this,d=c.widget,e=0,f=c.groups.length,g=0,h=d.body,i=d.leftBody,j=d.rightBody,k=0,l=d.groupRowHeight,m=[],n={};f>e;e++){var o=c.groups[e];if(c._expanded[o]===!0){for(m.push(k),n[k]=!0,g=0,a=d.columns.length;a>g;g++)b=h.getCell(k,g),b.css("margin-top",l+"px");for(g=0,a=d.leftColumns.length;a>g;g++)b=i.getCell(k,g),b.css("margin-top",l+"px");for(g=0,a=d.rightColumns.length;a>g;g++)b=j.getCell(k,g),b.css("margin-top",l+"px");k+=c.groupsCounts[o],l=d.groupRowHeight}else l+=d.groupRowHeight}if(c._renderFirstTime)c._renderFirstTime=!1;else{for(var e=0,f=c.prevRows.length,p=[];f>e;e++){var q=c.prevRows[e];n[q]!==!0&&p.push(q)}c.clearMargins(p)}c.prevRows=m},clearMargins:function(a){var b=this,a=a||b.prevRows;if(void 0!==a)for(var c,d,e,f=b.widget,g=f.body,h=f.leftBody,i=f.rightBody,j=0,k=0,l=a.length;l>j;j++){for(d=a[j],k=0,c=f.columns.length;c>k&&(e=g.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px");for(k=0,c=f.leftColumns.length;c>k&&(e=h.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px");for(k=0,c=f.rightColumns.length;c>k&&(e=i.getCell(d,k),void 0!==e.dom);k++)e.css("margin-top","0px")}},onColumnResize:function(){var a,b=this,c=b.widget,d=c.leftColumns,e=c.columns,f=c.rightColumns,g=c.body,h=c.leftBody,i=c.rightBody,j=0,k=0;for(a=e.length;a>j;j++)k+=e[j].width;for(g.el.select(".fancy-grid-group-row").css("width",k+"px"),j=0,k=0,a=d.length;a>j;j++)k+=d[j].width;for(a&&h.el.select(".fancy-grid-group-row").css("width",k+"px"),j=0,k=0,a=f.length;a>j;j++)k+=f[j].width;a&&i.el.select(".fancy-grid-group-row").css("width",k+"px")},update:function(a){var b=this,c=b.widget,d=c.store;return a||d.loading!==!0&&d.autoLoad!==!1?(b.setPositions(),c.update(),c.scroller.update(),b.setCellsPosition(),void c.setSidesHeight()):void d.once("load",function(){b.initGroups(),b.initOrder(),b.calcPlusScroll(),b.configParams(),d.changeDataView({doNotFired:!0}),b.renderGroupedRows(),b.update(!0)},b)},getOffsetForRow:function(a){for(var b=this,c=b.widget,d=0,e=b.groups.length,f=0,g=0;e>d;d++){var h=b.groups[d];if(f+=c.groupRowHeight,b._expanded[h]===!0&&(g+=b.groupsCounts[h]),g>a)break}return f},getSpecialRowsUnder:function(a){for(var b=this,c=b.widget,d=0,e=b.groups.length,f=0,g=0,h=0;e>d;d++){var i=b.groups[d];g>a&&h++,f+=c.groupRowHeight,b._expanded[i]===!0&&(g+=b.groupsCounts[i])}return h},reGroup:function(){var a=this,b=a.widget,c=b.store,d="data";a.expanded={},a._expanded={},b.store.expanded={},b.store.dataView=[],a.collapsed=!0,b.store.filteredData&&(d="filteredData"),a.removeGroupRows(),a.removeCells(),a.initGroups(d),c.remoteFilter&&a.initOrder(),a.calcPlusScroll(),a.configParams(),a.renderGroupedRows(),b.setSidesHeight()},scrollLeft:function(a){var b=this,c=b.widget,d=c.body;d.el.select("."+c.clsGroupRow).css("left",a)}});