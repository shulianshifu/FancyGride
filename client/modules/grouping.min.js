Fancy.Mixin("Fancy.store.mixin.Grouping",{expand:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.filteredData&&(d=c.filteredData,f=d.length),c.expanded=c.expanded||{},c.expanded[b]=!0;e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},collapse:function(a,b){var c=this,d=c.data,e=0,f=d.length,g=[],h={},i={};for(c.expanded=c.expanded||{},delete c.expanded[b];e<f;e++){var j=d[e];c.expanded[j.data[a]]&&(g.push(j),h[j.id]=g.length-1,i[g.length-1]=e)}c.dataView=g,c.dataViewMap=h,c.dataViewIndexes=i},changeOrderByGroups:function(a,b){var c=this,d={},e=[];Fancy.each(a,function(a){d[a]=[]}),Fancy.isArray(c.data)&&Fancy.each(c.data,function(a){var c=a.data[b];d[c].push(a)}),Fancy.each(a,function(a){e=e.concat(d[a])}),c.grouping={by:b},c.data=e},getColumnOriginalValuesByGroup:function(a,b,c){var d=this,e=d.data,f=0,g=e.length,h=[],i=[],j=e[0].data[b];if(c&&c.format&&"date"===c.type)for(;f<g;f++)e[f].data[b]===j?i.push(Fancy.Date.parse(e[f].data[a],c.format,c.mode)):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);else for(;f<g;f++)e[f].data[b]===j?i.push(e[f].data[a]):(h.push({values:i,groupName:j}),i=[],j=e[f].data[b],f--);return g>0&&h.push({values:i,groupName:j}),h},initGroups:function(a){var b=this,c=b.widget,d=c.grouping,a=a||"data",e=d.by;if(!e)throw new Error("[FancyGrid Error] - not set by param in grouping");var f=b.getColumnOriginalValues(e,{dataProperty:a,groupMap:!0}),g={};Fancy.each(f,function(a){void 0===g[a]&&(g[a]=0),g[a]++});var h=[];for(var i in g)h.push(i);return{groups:h,_groups:g}},orderDataByGroupOnStart:function(){var a=this,b=a.widget.grouping,c=a.initGroups(),d=c.groups,e={},f=[];Fancy.each(d,function(a){var b=a.toLocaleUpperCase();e[b]=a,f.push(b)}),f=f.sort();for(var g=0,h=d.length;g<h;g++)d[g]=e[f[g]];a.changeOrderByGroups(d,b.by),a.expanded={},b.collapsed?a.collapsed=!0:Fancy.each(d,function(c){b.expanded&&void 0!==b.expanded[c]||(a.expanded[c]=!0)}),a.changeDataView({doNotFired:!0})}}),Fancy.define("Fancy.grid.plugin.Grouping",{extend:Fancy.Plugin,ptype:"grid.grouping",inWidgetName:"grouping",tpl:"{text}:{number}",_renderFirstTime:!0,groupRowInnerCls:"fancy-grid-group-row-inner",constructor:function(a){this.Super("const",arguments)},init:function(){var a=this,b=a.widget;a.Super("init",arguments),a._expanded={},a.initTpl(),a.initGroups(),a.initOrder(),a.calcPlusScroll(),a.configParams(),a.ons(),!a.collapsed&&b.store.data&&setTimeout(function(){b.store.changeDataView({doNotFired:!0}),b.update()},100)},ons:function(){var a=this,b=a.widget,c=b.store;b.once("render",function(){a.renderGroupedRows(),a.update(),b.el.on("click",a.onClick,a,"div."+b.clsGroupRow),b.el.on("mousedown",a.onMouseDown,a,"div."+b.clsGroupRow),b.on("scroll",a.onScroll,a),b.on("columnresize",a.onColumnResize,a),c.on("insert",a.onInsert,a),c.on("remove",a.onRemove,a)})},onInsert:function(){this.reGroup()},onRemove:function(){this.reGroup()},initGroups:function(a){var b=this,c=b.widget,d=c.store,e=d.initGroups(a);b.groups=e.groups,b.groupsCounts=e._groups},getGroupById:function(a){return this.widget.store.groupMap[a]},getGroupOrderIndex:function(a){for(var b=this,c=b.groups,d=0,e=c.length;d<e;d++)if(c[d]===a)return d},initOrder:function(){var a,b,c=this,d=c.widget,e=d.store,f=[],g={},h=[];if(c.order&&0!==c.order.length)Fancy.typeOf(c.order);else for(f=c.groups,a=0,b=f.length,Fancy.each(f,function(a){var b=a.toLocaleUpperCase();g[b]=a,h.push(b)}),h=h.sort();a<b;a++)f[a]=g[h[a]];c.groups=f,e.changeOrderByGroups(f,c.by)},calcPlusScroll:function(){var a=this,b=a.widget;a.plusScroll=a.groups.length*b.groupRowHeight},configParams:function(){var a=this,b=a.widget,c=b.store;a.expanded=a.expanded||{},c.expanded=c.expanded||{},a.collapsed?c.collapsed=!0:Fancy.each(a.groups,function(b){void 0===a.expanded[b]&&(c.expanded[b]=!0,a.expanded[b]=!0,a._expanded[b]=!0)})},renderGroupedRows:function(){var a,b=this,c=b.widget,d=c.body,e=c.leftBody,f=c.rightBody,g=c.getCenterFullWidth(),h=c.getLeftFullWidth(),i=c.getRightFullWidth(),j=0;Fancy.each(b.groups,function(k){var l=b.groupsCounts[k];h?(a=b.generateGroupRow(k,l,!0,j),a.css("width",h),e.el.dom.appendChild(a.dom),a=b.generateGroupRow(k,l,!1,j),a.css("width",g),d.el.dom.appendChild(a.dom)):(a=b.generateGroupRow(k,l,!0,j),a.css("width",g),d.el.dom.appendChild(a.dom)),i&&(a=b.generateGroupRow(k,l,!1,j),a.css("width",i),f.el.dom.appendChild(a.dom)),b.collapsed&&(j+=c.groupRowHeight)})},removeGroupRows:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody,i=b.clsGroupRow;c.length&&f.el.select("."+i).remove(),d.length&&g.el.select("."+i).remove(),e.length&&h.el.select("."+i).remove()},removeCells:function(){var a=this,b=a.widget,c=b.columns,d=b.leftColumns,e=b.rightColumns,f=b.body,g=b.leftBody,h=b.rightBody,i=b.cellCls;c.length&&f.el.select("."+i).remove(),d.length&&g.el.select("."+i).remove(),e.length&&h.el.select("."+i).remove()},generateGroupRow:function(a,b,c,d){var e=this,f=e.widget,g=f.clsGroupRow,h=Fancy.get(document.createElement("div")),i=e.groupRowInnerCls;if(h.addCls(g),h.attr("group",a),c){var j=e.tpl.getHTML({text:a,number:b});h.update('<div class="'+i+'"> '+j+"</div>")}return e.collapsed?(h.css("top",d+"px"),h.addCls(f.clsCollapsedRow)):h.css("top","0px"),h},insertGroupEls:function(){var a=this,b=a.widget,c=b.leftBody,d=b.body,e=b.clsGroupRow,f=a.groupRowInnerCls;b.leftColumns.length?c.el.select("."+e).each(function(b){var c=a.groups[i];b.update('<div class="'+f+'">'+c+"</div>")}):d.el.select("."+e).each(function(b,c){var d=a.groups[c],e=a.groupsCounts[d],g=a.tpl.getHTML({text:d,number:e});b.update('<div class="'+f+'">'+g+"</div>")})},onClick:function(a){var b,c=this,d=c.widget,e=d.clsCollapsedRow,f=Fancy.get(a.currentTarget),g=f.attr("group");d.el.select("."+d.clsGroupRow+'[group="'+g+'"]').toggleCls(e),b=f.hasCls(e),b?c.collapse(c.by,g):c.expand(c.by,g),c.update()},fastCollapse:function(){},onMouseDown:function(a){a.preventDefault()},onScroll:function(){this.setPositions()},collapse:function(a,b){var c=this,d=c.widget;d.store.collapse(a,b),delete c._expanded[b],delete c.expanded[b],d.fire("collapse",a,b)},expand:function(a,b){var c=this,d=c.widget;d.store.expand(a,b),c._expanded[b]=!0,c.expanded[b]=!0,d.fire("expand",a,b)},setPositions:function(){var a=this,b=a.widget,c=-b.scroller.scrollTop||0,d=b.clsGroupRow,e=b.leftBody.el.select("."+d),f=b.body.el.select("."+d),g=b.rightBody.el.select("."+d);Fancy.each(a.groups,function(d,h){if(e.length&&e.item(h).css("top",c+"px"),f.length&&f.item(h).css("top",c+"px"),g.length&&g.item(h).css("top",c+"px"),b.expander){var i=b.expander.expandedGroups[d];for(var j in i){var k=i[j];c+=parseInt(k.el.css("height"))}}c+=b.groupRowHeight,!0===a._expanded[d]&&(c+=a.groupsCounts[d]*b.cellHeight)})},setCellsPosition:function(a,b){for(var c,d,e=this,f=e.widget,g=0,h=e.groups.length,i=0,j=f.body,k=f.leftBody,l=f.rightBody,m=0,n=f.groupRowHeight,o=[],p={},q={},r=e.by;g<h;g++){var s=e.groups[g];if(!0===e._expanded[s]){if(o.push(m),p[m]=!0,void 0===b||"center"===b)if(i=0,c=f.columns.length,void 0!==a&&(i=a,c=a+1),f.expander){var t=f.get(m),u=t.get(r),v=f.expander.expandedGroups,w=e.getGroupOrderIndex(s),x=0;for(var y in v){var z=e.getGroupOrderIndex(y);if(!(w<=z)){var A=v[y];for(var B in A){var C=A[B];if("none"!==C.el.css("display")&&!q[B]){var D=m-1;m<0&&(m=0),D=f.get(D);var E=D.get(r);u!==E?D.id===B&&(q[B]=!0,x+=parseInt(C.el.css("height"))):(q[B]=!0,x+=parseInt(C.el.css("height")))}}}}for(n+=x,d=j.getCell(m,i);i<c;i++)d=j.getCell(m,i),d.css("margin-top",n+"px")}else for(;i<c;i++)d=j.getCell(m,i),d.css("margin-top",n+"px");if(void 0===b||"left"===b)for(i=0,c=f.leftColumns.length,void 0!==a&&(i=a,c=a+1);i<c;i++)d=k.getCell(m,i),d.css("margin-top",n+"px");if(void 0===b||"right"===b)for(i=0,c=f.rightColumns.length,void 0!==a&&(i=a,c=a+1);i<c;i++)d=l.getCell(m,i),d.css("margin-top",n+"px");m+=e.groupsCounts[s],n=f.groupRowHeight}else n+=f.groupRowHeight}if(e._renderFirstTime)e._renderFirstTime=!1;else{var F=[];Fancy.each(e.prevRows,function(a){!0!==p[a]&&F.push(a)}),e.clearMargins(F)}e.prevRows=o},setExpanderCellsPosition:function(){var a,b,c=this,d=c.widget,e=d.store,f=e.dataView,g=d.body,h=d.leftBody,i=d.rightBody,j=d.expander.expandedGroups,k=c.groupsCounts,l=d.groupRowHeight,m=0,n=0;Fancy.each(c.groups,function(e){if(!0===c._expanded[e]){for(var o=m+k[e];m<o;m++)if(b=f[m]){var p=b.id,q=j[e][p];n&&(l+=n,n=0),q&&(n=parseInt(q.el.css("height"))),Fancy.each(d.columns,function(b,c){a=g.getCell(m,c),a.css("margin-top",l+"px")}),Fancy.each(d.leftColumns,function(b,c){a=h.getCell(m,c),a.css("margin-top",l+"px")}),Fancy.each(d.rightColumns,function(b,c){a=i.getCell(m,c),a.css("margin-top",l+"px")}),l=0}l=d.groupRowHeight}else l+=d.groupRowHeight})},clearMargins:function(a){var b=this,a=a||b.prevRows;if(void 0!==a){var c,d=b.widget,e=d.body,f=d.leftBody,g=d.rightBody;Fancy.each(a,function(a){Fancy.each(d.columns,function(b,d){if(c=e.getCell(a,d),void 0===c.dom)return!0;c.css("margin-top","0px")}),Fancy.each(d.leftColumns,function(b,d){if(c=f.getCell(a,d),void 0===c.dom)return!0;c.css("margin-top","0px")}),Fancy.each(d.rightColumns,function(b,d){if(c=g.getCell(a,d),void 0===c.dom)return!0;c.css("margin-top","0px")})})}},onColumnResize:function(){this.updateGroupRows()},updateGroupRows:function(){var a=this,b=a.widget,c=b.leftColumns,d=b.rightColumns,e=b.body,f=b.leftBody,g=b.rightBody,h=b.clsGroupRow,i=0;i+=b.getCenterFullWidth(),e.el.select("."+h).css("width",i+"px"),i+=b.getLeftFullWidth(),c.length&&f.el.select("."+h).css("width",i+"px"),i+=b.getRightFullWidth(),d.length&&g.el.select("."+h).css("width",i+"px")},update:function(a){var b=this,c=b.widget,d=c.store;a||!0!==d.loading&&!1!==d.autoLoad||d.data.length?a&&d.data.length&&d.loadedTimes>1?b.reGroup():(b.setPositions(),c.update(),c.scroller.update(),b.setCellsPosition(),c.setSidesHeight()):d.on("load",function(){b.initGroups(),b.initOrder(),b.calcPlusScroll(),b.configParams(),d.changeDataView({doNotFired:!0}),b.renderGroupedRows(),b.update(!0)},b)},getOffsetForRow:function(a){var b=this,c=b.widget,d=0,e=0;return Fancy.each(b.groups,function(f){if(d+=c.groupRowHeight,!0===b._expanded[f]&&(e+=b.groupsCounts[f]),a<e)return!0}),d},getSpecialRowsUnder:function(a){var b=this,c=b.widget,d=0,e=0,f=0;return Fancy.each(b.groups,function(g){a<e&&f++,d+=c.groupRowHeight,!0===b._expanded[g]&&(e+=b.groupsCounts[g])}),f},reGroup:function(){var a=this,b=a.widget,c=b.store,d="data";a.expanded={},a._expanded={},b.store.expanded={},b.store.dataView=[],a.collapsed=!0,b.store.filteredData&&(d="filteredData"),a.removeGroupRows(),a.removeCells(),a.initGroups(d),c.remoteFilter&&a.initOrder(),a.calcPlusScroll(),a.configParams(),a.renderGroupedRows(),b.setSidesHeight()},scrollLeft:function(a){var b=this,c=b.widget;c.body.el.select("."+c.clsGroupRow).css("left",a)}});