Fancy.modules.filter=!0,Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.widget,d=c.filterCaseSensitive,e=b.filters,f=!0,g=!1,h=!1;if(void 0===a.data&&(a=new Fancy.Model(a)),b.isTree){var i=a.get("child");if(i){var j=[];if(Fancy.each(i,function(a){var c=a.data?a:new b.model(a);b.filterCheckItem(c)&&j.push(a)}),a.set("filteredChild",j),j.length)return!0}}for(var k in e){var l=c.getColumnByIndex(k),m=e[k],n=a.data[k];if(l&&l.filter&&l.filter.fn)return l.filter.fn(n,e,a);if(b.smartIndexes&&b.smartIndexes[k])n=b.smartIndexes[k](a.data);else if(/\./.test(k)){var o=k.split(".");n=a.data[o[0]][o[1]]}"date"===m.type&&(n=null===n?Number.NEGATIVE_INFINITY:Number(Fancy.Date.parse(n,m.format.read,m.format.mode))),!d&&Fancy.isString(n)&&(n=n.toLocaleLowerCase());for(var p in m){switch(p){case"type":case"format":continue}var q=m[p];switch(!d&&Fancy.isString(q)&&(q=q.toLocaleLowerCase()),p){case"<":f=Number(n)<q;break;case">":f=Number(n)>q;break;case"<=":f=Number(n)<=q;break;case">=":f=Number(n)>=q;break;case"=":case"==":Fancy.isArray(q)?(Fancy.each(q,function(a,b){q[b]=String(a)}),n=String(n),f=-1!==q.indexOf(n)):f=n==q;break;case"===":Fancy.isArray(q)?(n=String(n),f=-1!==q.indexOf(n)):f=n===q;break;case"!==":f=n!==q;break;case"!=":Fancy.isArray(q)?(Fancy.each(q,function(a,b){q[b]=String(a)}),n=String(n),f=-1===q.indexOf(n)):f=n!=q;break;case"":var r=function(a,b){return a=String(a).toLocaleLowerCase(),b=String(b).toLocaleLowerCase(),a=a.replace(/\(/g,"bracketleft"),a=a.replace(/\)/g,"bracketright"),a=a.replace(/\+/g,"plus"),a=a.replace(/\-/g,"minus"),b=b.replace(/\(/g,"bracketleft"),b=b.replace(/\)/g,"bracketright"),b=b.replace(/\+/g,"plus"),b=b.replace(/\-/g,"minus"),new RegExp(a).test(b)};if(Fancy.isArray(q))for(var s=0,t=q.length;s<t&&!1!==(f=r(q[s],n));s++);else f=r(q,n);break;case"*":q=String(q).toLocaleLowerCase(),f=new RegExp(q).test(String(n).toLocaleLowerCase()),f&&(h=!0),g=!0;break;case"|":f=!0===q[String(n).toLocaleLowerCase()];break;case"fn":f=!0===q(n,a);break;default:throw new Error("[FancyGrid Error 5]: Unknown filter "+p)}if("*"!==p&&!1===f)return!1}}return(!0!==g||!1!==h)&&(!0!==g||!0!==f||!1!==h)},filterData:function(a){var b=this,c=b.data,d=[],e=0,f=c.length,g=[],h=[];if(b.remoteFilter)return void b.serverFilter();for(b.filteredDataMap={};e<f;e++)b.order?(g.push(b.order[e]),h=c[b.order[e]]):(g.push(e),h=c[e]),b.filterCheckItem(h)&&(d.push(h),b.filteredDataMap[h.id]=h);b.filterOrder=g,b.filteredData=d,b.paging&&b.calcPages(),!1!==a&&b.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){switch(f){case"type":case"format":continue}var g=a.filterOperators[f];if("or"===g){var h=[];for(var i in e[f])h.push(i);b+='{"operator":"'+g+'","value":"'+h.join(", ")+'","property":"'+d+'"},'}else b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=b,a.loadData()},hasFilters:function(){var a=this;if(!a.filters)return!1;for(var b in a.filters)return!0;return!1}}),Fancy.modules.filter=!0,function(){var a=Fancy,b=a.FIELD_CLS,c=a.FIELD_CHECKBOX_CLS,d=a.GRID_HEADER_CELL_DOUBLE_CLS,e=a.GRID_HEADER_CELL_TRIPLE_CLS,f=a.GRID_HEADER_CELL_FILTER_CLS,g=a.GRID_HEADER_CELL_FILTER_FULL_CLS,h=a.GRID_HEADER_CELL_FILTER_SMALL_CLS,i=a.GRID_HEADER_CELL_FILTERED_CLS;a.define("Fancy.grid.plugin.Filter",{extend:a.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,constructor:function(){this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this,b=a.widget;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a),b.on("filter",a.onFilter,a),b.on("lockcolumn",a.onLockColumn,a),b.on("rightlockcolumn",a.onRightLockColumn,a),b.on("unlockcolumn",a.onUnLockColumn,a),b.on("columndrag",a.onColumnDrag,a)},render:function(){var a=this,b=a.widget;b.header&&(a._renderSideFields(b.header,b.columns),a._renderSideFields(b.leftHeader,b.leftColumns),a._renderSideFields(b.rightHeader,b.rightColumns))},_renderSideFields:function(a,b){for(var c,g,h=this,i=0,j=b.length;i<j;i++)g=b[i],c=a.getCell(i),g.filter&&g.filter.header?(h.renderFilter(g.type,g,c),h.groupHeader&&!g.grouping&&c.addCls(e),c.addCls(f)):h.header&&(h.groupHeader&&!g.grouping?c.addCls(e):g.grouping&&h.groupHeader?c.addCls(d):g.grouping||c.addCls(d))},_clearColumnsFields:function(c,d,e,f){for(var g,h=0,i=c.length;h<i;h++)if(g=c[h],g.filter&&g.filter.header){if(e&&g.index!==e)continue;switch(g.type){case"date":var j=d.getCell(h).select("."+b),k=a.getWidget(j.item(0).attr("id")),l=a.getWidget(j.item(1).attr("id"));k.clear(),l.clear();break;default:var m=d.getCell(h).select("."+b).attr("id"),n=a.getWidget(m);if(f){var o=n.get().split(",");if(o.length<2&&!f)n.clear();else{for(var p=0,q=o.length,r="";p<q;p++){var s=o[p];new RegExp(f).test(s)||(r+=s+",")}","===r[r.length-1]&&(r=r.substring(0,r.length-1)),n.set(r)}}else n.clear()}}},clearColumnsFields:function(a,b){var c=this,d=c.widget;c._clearColumnsFields(d.columns,d.header,a,b),c._clearColumnsFields(d.leftColumns,d.leftHeader,a,b),c._clearColumnsFields(d.rightColumns,d.rightHeader,a,b)},_addValuesInColumnFields:function(c,d,e,f,g){for(var h,i=0,j=c.length;i<j;i++)if(h=c[i],h.index===e&&h.filter&&h.filter.header)switch(h.type){case"date":var k=d.getCell(i).select("."+b),l=a.getWidget(k.item(0).attr("id")),m=a.getWidget(k.item(1).attr("id"));switch(g){case">":case">=":l.set(new Date(f));break;case"<":case"<=":m.set(new Date(f))}break;case"combo":var n=d.getCell(i).select("."+b).attr("id"),o=a.getWidget(n);a.isArray(f),o.set(f);break;default:var n=d.getCell(i).select("."+b).attr("id"),o=a.getWidget(n);o.set((g||"")+f)}},addValuesInColumnFields:function(b,c,d){var e=this,f=e.widget;void 0!==c&&null!==c&&0!==c.length&&(a.isFunction(c)||(e._addValuesInColumnFields(f.columns,f.header,b,c,d),e._addValuesInColumnFields(f.leftColumns,f.leftHeader,b,c,d),e._addValuesInColumnFields(f.rightColumns,f.rightHeader,b,c,d)))},renderFilter:function(b,c,d){var e,f=this,g=f.widget,h=g.store,i={position:"absolute",bottom:"3px"},j=c.filter,k=g.theme,l=j.tip,m="",n=h.filters[c.index];if(n)if("date"===n.type)m=[n[">="],n["<="]];else for(var o in n){var p=n[o];switch(o){case"":m+=p;break;default:if("combo"===c.type)if(m=m||[],Fancy.isObject(p))for(var q in p)m.push(q);else m.push(p);else m+=o+p+","}}if(","===m[m.length-1]&&(m=m.substring(0,m.length-1)),Fancy.isObject(j.header)){var r=j.header;a.apply(r,{renderTo:d.dom,label:!1,style:i,theme:k,widget:g,tip:l,value:m,padding:!1});var s={combo:"Combo"};"combo"===r.type&&a.apply(r,{width:c.width-8,height:28,multiSelect:c.multiSelect,itemCheckBox:c.itemCheckBox,minListWidth:c.minListWidth,listItemTpl:c.listItemTpl});var t=s[r.type];e=new a[t](r)}else switch(b){case"date":var u=[];u.push({change:f.onDateChange,scope:f}),e=new a.DateRangeField({renderTo:d.dom,format:c.format,label:!1,padding:!1,style:i,events:u,width:c.width-8,emptyText:j.emptyText,dateImage:!1,value:m,theme:k});break;case"string":var u=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&u.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,padding:!1,style:i,events:u,emptyText:j.emptyText,tip:l,value:m,widget:g});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var u=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&u.push({key:f.onKey,scope:f}),e=new a.NumberField({renderTo:d.dom,label:!1,padding:!1,style:i,emptyText:j.emptyText,events:u,widget:g,value:m,tip:l});break;case"combo":var v,w="text",x="text";void 0!==c.displayKey&&(w=c.displayKey,x=w),v=a.isObject(c.data)||a.isObject(c.data[0])?c.data:f.configComboData(c.data);var y;c.filter&&c.filter.selectAll&&(y=c.filter.selectAll),e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:i,width:c.width-8,displayKey:w,valueKey:x,value:m,height:28,emptyText:j.emptyText,theme:k,widget:g,tip:l,multiSelect:c.multiSelect,itemCheckBox:c.itemCheckBox,minListWidth:c.minListWidth,listItemTpl:c.listItemTpl,selectAllText:y,subSearch:c.subSearch,events:[{change:f.onEnter,scope:f},{empty:function(){this.set(-1)}}],data:v});break;case"select":g.selection&&/row/.test(g.selection.selModel)&&(e=new a.Combo({renderTo:d.dom,label:!1,padding:!1,style:i,displayKey:"text",valueKey:"value",width:c.width-8,emptyText:j.emptyText,value:m,editable:!1,subSearch:!1,events:[{change:f.onEnterSelect,scope:f}],data:[{value:"",text:""},{value:"false",text:g.lang.no},{value:"true",text:g.lang.yes}]}));break;case"checkbox":case"switcher":e=new a.Combo({theme:k,renderTo:d.dom,label:!1,padding:!1,style:i,displayKey:"text",valueKey:"value",width:c.width-8,emptyText:j.emptyText,value:m,editable:!1,subSearch:!1,events:[{change:f.onEnter,scope:f}],data:[{value:"",text:""},{value:"false",text:g.lang.no},{value:"true",text:g.lang.yes}]});break;default:var u=[{enter:f.onEnter,scope:f}];!1!==f.autoEnterDelay&&u.push({key:f.onKey,scope:f}),e=new a.StringField({renderTo:d.dom,label:!1,style:i,padding:!1,value:m,emptyText:j.emptyText,events:u})}switch(e.filterIndex=c.index,e.column=c,"date"!==b&&(e.el.css("padding-left","4px"),e.el.css("padding-top","0px")),b){case"checkbox":case"combo":case"date":break;default:e.setInputSize({width:c.width-8})}c.filterField=e},onEnter:function(b,c,d){var e=this,f=e.widget,g=f.store,h=b.filterIndex;if(d=d||{},e.intervalAutoEnter&&(clearInterval(e.intervalAutoEnter),e.intervalAutoEnter=!1),delete e.intervalAutoEnter,0===c.length)return g.filters[b.filterIndex]={},e.clearFilter(b.filterIndex,void 0,!1),e.updateStoreFilters(),void(f.grouping&&f.grouping.reGroup());var i=e.processFilterValue(c,b.column.type),j=0,k=i.length;for(g.filters[h]={};j<k;j++){var l=i[j];""===l.operator&&b.column.filter&&b.column.filter.operator&&(l.operator=b.column.filter.operator),"&"===l.separator?a.isArray(g.filters[h][l.operator])?g.filters[h][l.operator].push(l.value):g.filters[h][l.operator]=[l.value]:g.filters[h][l.operator]=l.value,l.operator,"date"===b.column.type&&a.apply(g.filters[h],d)}g.remoteFilter?(g.once("serversuccess",function(){f.fire("filter",g.filters)}),g.serverFilter()):e.updateStoreFilters(),f.grouping&&(g.remoteSort?g.once("load",function(){f.grouping.reGroup(),f.fire("filter",g.filters)}):f.grouping.reGroup()),f.setSidesHeight()},onEnterSelect:function(a,b){var c=this,d=c.widget,e=d.getSelection(),f=[];Fancy.each(e,function(a){f.push(a.id)}),b===String(!0)?f.length?d.addFilter("id",f,"="):(d.clearFilter("id","="),d.clearFilter("id","!=")):b===String(!1)?(d.clearFilter("id","="),d.addFilter("id",f,"!=")):d.clearFilter("id")},processFilterValue:function(b,c){var d,e,f,g,h,i={"<":!0,">":!0,"!":!0,"=":!0,"|":!0},j=0,k=3,l=[];if(a.isArray(b))return e={},a.Array.each(b,function(a){e[String(a).toLocaleLowerCase()]=!0}),l.push({operator:"|",value:e}),l;var m=",";for(/\&/.test(b)&&(m="&"),f=b.split(m),g=0,h=f.length;g<h;g++){for(j=0,d="",e=f[g];j<k;j++)i[e[j]]&&(d+=e[j]);if(e=e.replace(new RegExp("^"+d),""),!(e.length<1)){switch(c){case"number":e=Number(e);break;case"combo":d="="}l.push({operator:d,value:e,separator:m})}}return l},updateStoreFilters:function(a){var b=this,c=b.widget,d=c.store,e=!1;c.filtering=!0;for(var f in d.filters){if(d.filters[f]){e=!0;break}}e||delete d.filteredData,d.changeDataView(),!1!==a&&(c.update(),c.fire("filter",d.filters),c.setSidesHeight()),e||(delete d.filteredData,delete d.filteredDataMap,delete d.filterOrder),delete c.filtering},forceUpdateStoreFilters:function(){var a=this,b=a.widget,c=b.store;c.changeDataView(),b.update(),b.fire("filter",c.filters),b.setSidesHeight()},onColumnResize:function(d,e){var f,g=a.get(e.cell),h=e.width,i=g.select(":not(."+c+")."+b);i.length,0===i.length||(2===i.length?(f=a.getWidget(i.item(0).dom.id),f.setWidth((h-8)/2),f=a.getWidget(i.item(1).dom.id),f.setWidth((h-8)/2)):(f=a.getWidget(i.dom.id),"field.combo"===f.wtype?(f.size({width:h-8}),f.el.css("width",h-8+5)):f.setInputSize({width:h-8})))},onKey:function(b,c,d){var e=this;d.keyCode!==a.key.ENTER&&(e.autoEnterTime=+new Date,e.intervalAutoEnter||(e.intervalAutoEnter=setInterval(function(){var a=new Date;e.intervalAutoEnter&&a-e.autoEnterTime>e.autoEnterDelay&&(clearInterval(e.intervalAutoEnter),delete e.intervalAutoEnter,c=b.getValue(),e.onEnter(b,c))},200)))},onDateChange:function(b){var c,d,e,f=this,g=f.widget,h=b.format,i=g.store,j=b.dateField1.getDate(),k=b.dateField2.getDate(),l="Invalid Date"!==j.toString()&&a.isDate(j),m="Invalid Date"!==k.toString()&&a.isDate(k),n=i.remoteFilter;l&&(j=new Date(j.getFullYear(),j.getMonth(),j.getDate())),m&&(k=new Date(k.getFullYear(),k.getMonth(),k.getDate())),l&&m?(!0!==n?(d=Number(j),e=Number(k)):(d=a.Date.format(j,h.edit,h.mode),e=a.Date.format(k,h.edit,h.mode)),c=">="+d+",<="+e):l?(c=!0!==n?">="+Number(j):">="+a.Date.format(j,h.edit,h.mode),f.clearFilter(b.filterIndex,"<=",!1)):m?(c=!0!==n?"<="+Number(k):"<="+a.Date.format(j,h.edit,h.mode),f.clearFilter(b.filterIndex,">=",!1)):f.clearFilter(b.filterIndex),c&&f.onEnter(b,c,{type:"date",format:b.format})},clearFilter:function(a,b,c){var d=this,e=d.widget,f=e.store;f._clearedFilter=!0,setTimeout(function(){delete f._clearedFilter},1),void 0===b?delete f.filters[a]:f.filters[a]&&delete f.filters[a][b],!1!==c&&d.updateStoreFilters()},onFilter:function(a,b){var c=this,d=c.widget;if(d.scroll(0),d.header&&b){d.el.select("."+i).removeCls(i);for(var e in b){var f=d.getHeaderCell(e);f&&f.addCls(i)}}},configComboData:function(b){var c=0,d=b.length,e=[];if(a.isObject(b))return b;for(;c<d;c++)e.push({value:c,text:b[c]});return e},destroyFields:function(){var b=this,c=b.widget;a.each(c.columns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(c.leftColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),a.each(c.rightColumns,function(a){a.filterField&&(a.filterField.destroy(),delete a.filterField)}),c.el.select("."+f).removeCls(f),c.el.select("."+g).removeCls(g),c.el.select("."+h).removeCls(h),c.el.select("."+d).removeCls(d),c.el.select("."+e).removeCls(e)},onLockColumn:function(){this.render()},onUnLockColumn:function(){this.render()},onRightLockColumn:function(){this.render()},onColumnDrag:function(){this.updateFields()},updateFields:function(){var a=this;a.destroyFields(),a.render()}})}(),Fancy.define("Fancy.grid.plugin.Search",{extend:Fancy.Plugin,ptype:"grid.search",inWidgetName:"searching",autoEnterDelay:500,constructor:function(){this.searches={},this.Super("const",arguments)},init:function(){this.Super("init",arguments),this.ons()},ons:function(){var a=this;a.widget.once("init",function(){a.generateKeys()})},search:function(a,b){var c=this,d=c.widget,e=d.store;if(c.searches={},!a&&!b)return c.clear(),c.updateStoreSearches(),void(d.grouping&&d.grouping.reGroup());!1!==Fancy.isArray(a)||b||(c.searches=a),c.setFilters(),e.remoteSort?e.serverFilter():(c.updateStoreSearches(),setTimeout(function(){d.fire("filter",e.filters)},1)),d.grouping&&(e.remoteSort?e.once("load",function(){d.grouping.reGroup()}):d.grouping.reGroup())},updateStoreSearches:function(){var a=this.widget;a.store.changeDataView(),a.update()},setKeys:function(a){var b=this;b.keys=a,b.setFilters(),b.updateStoreSearches()},generateKeys:function(){var a=this,b=a.widget;if(a.items)a.keys={},Fancy.each(a.items,function(b){a.keys[b.index]=!0});else if(!a.keys){a.keys={};var c=[];b.columns&&(c=c.concat(b.columns)),b.leftColumns&&(c=c.concat(b.leftColumns)),b.rightColumns&&(c=c.concat(b.rightColumns));var d=[];Fancy.each(c,function(a){var b=a.index;if(!1!==a.searchable){switch(a.type){case"color":case"combo":case"date":case"number":case"string":case"text":case"currency":break;default:return}b&&d.push(b)}}),Fancy.each(d,function(b){"$selected"!==b&&(a.keys[b]=!0)})}return a.keys},setFilters:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};if(void 0===a.searches||Fancy.isObject(a.searches))return void a.clear();for(var e in a.keys)!1!==a.keys[e]?(d[e]=d[e]||{},d[e]["*"]=a.searches):d[e]&&delete d[e]["*"];c.filters=d},clear:function(){var a=this,b=a.widget,c=b.store,d=c.filters||{};for(var e in a.keys)void 0!==d[e]&&delete d[e]["*"];c.filters=d,delete a.searches,b.state&&b.state.onFilter()},clearBarField:function(){var a=this,b=a.getSearchField("tbar");b&&b.clear(),(b=a.getSearchField("subTBar"))&&b.clear()},setValueInField:function(a){var b=this,c=b.getSearchField("tbar");c&&c.set(a,!1),(c=b.getSearchField("subTBar"))&&c.set(a,!1)},getSearchField:function(a){for(var b,c=this,d=c.widget,e=d[a],f=0,g=(e||[]).length;f<g;f++)if(b=e[f],"search"===b.type)return b;return b}});