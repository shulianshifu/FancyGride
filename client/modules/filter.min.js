Fancy.Mixin("Fancy.store.mixin.Filter",{filterCheckItem:function(a){var b=this,c=b.filters,d=!0;for(var e in c){var f=c[e],g=a.data[e];"date"===f.type&&(g=Number(Fancy.Date.parse(g,f.format.edit)));for(var h in f){switch(h){case"type":case"format":continue}var i=f[h];switch(h){case"<":d=i>g;break;case">":d=g>i;break;case"<=":d=i>=g;break;case">=":d=g>=i;break;case"=":case"==":d=g==i;break;case"===":d=g===i;break;case"!==":d=g!==i;break;case"!=":d=g!=i;break;case"":d=new RegExp(i).test(String(g))}if(d===!1)return!1}}return!0},filterData:function(){var a=this,b=a.data,c=[],d=0,e=b.length,f=[],g=[];for(a.remoteFilter&&a.serverFilter();e>d;d++)a.order?(f.push(a.order[d]),g=b[a.order[d]]):(f.push(d),g=b[d]),a.filterCheckItem(g)&&c.push(g);a.filterOrder=f,a.filteredData=c,a.paging&&a.calcPages(),a.fire("filter")},serverFilter:function(){var a=this,b="[",c=a.filters||{};for(var d in c){var e=c[d];for(var f in e){switch(f){case"type":case"format":continue}var g=a.filterOperators[f];b+='{"operator":"'+g+'","value":"'+e[f]+'","property":"'+d+'"},'}}b=b.replace(/\,$/,""),b+="]",a.params=a.params||{},"[]"===b?(b="",delete a.params[a.filterParam]):a.params[a.filterParam]=encodeURIComponent(b),a.loadData()}}),Fancy.define("Fancy.grid.plugin.Filter",{extend:Fancy.Plugin,ptype:"grid.filter",inWidgetName:"filter",autoEnterDelay:500,constructor:function(a){var b=this;b.filters={},b.Super("const",arguments)},init:function(){var a=this;a.Super("init",arguments),a.ons()},ons:function(){var a=this,b=a.widget;b.store;b.once("render",function(){a.render()}),b.on("columnresize",a.onColumnResize,a)},render:function(){for(var a,b,c=this,d=c.widget,e=(d.body,d.leftBody,d.rightBody,d.header),f=d.leftHeader,g=d.rightHeader,h=d.columns,i=d.leftColumns,j=d.rightColumns,k=0,l=h.length;l>k;k++)a=h[k],b=e.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize);for(k=0,l=i.length;l>k;k++)a=i[k],b=f.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize);for(k=0,l=j.length;l>k;k++)a=j[k],b=g.getCell(k),a.filter&&a.filter.header?(c.renderFilter(a.type,a,b),b.addClass(d.filterHeaderCellCls)):c.header&&b.addClass(d.cellHeaderDoubleSize)},renderFilter:function(a,b,c){var d,e=this,f=e.widget,g={position:"absolute",bottom:"3px"},h=b.filter,i=f.theme;switch(a){case"date":var j=[];j.push({change:e.onDateChange,scope:e});var k;if(Fancy.isString(b.format))switch(b.format){case"date":k=b.format}d=new Fancy.DateRangeField({renderTo:c.dom,value:new Date,format:b.format,label:!1,padding:!1,style:g,events:j,width:b.width-8,emptyText:h.emptyText,dateImage:!1,theme:i});break;case"string":var j=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&j.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,padding:!1,style:g,events:j,emptyText:h.emptyText});break;case"number":case"grossloss":case"progressbar":case"progressdonut":var j=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&j.push({key:e.onKey,scope:e}),d=new Fancy.NumberField({renderTo:c.dom,label:!1,padding:!1,style:g,emptyText:h.emptyText,events:j});break;case"combo1":for(var l=[],m=0,n=b.data.length;n>m;m++){var o=b.data[m];l.push({index:o,valueText:o})}d=new Fancy.TagField({renderTo:c.dom,label:!1,style:g,displayKey:"valueText",valueKey:"index",value:"",itemCheckBox:!0,theme:i,events:[{change:e.onEnter,scope:e}],data:l}),d.size({width:b.width-26,height:26});break;case"combo":var l=[],m=0,n=b.data.length;for(l.push({index:"",valueText:""});n>m;m++){var o=b.data[m];l.push({index:o,valueText:o})}d=new Fancy.Combo({renderTo:c.dom,label:!1,padding:!1,style:g,width:b.width-8,displayKey:"valueText",valueKey:"index",value:"",itemCheckBox:!0,height:28,emptyText:h.emptyText,theme:i,events:[{change:e.onEnter,scope:e}],data:l});break;case"checkbox":d=new Fancy.Combo({renderTo:c.dom,label:!1,padding:!1,style:g,displayKey:"valueText",valueKey:"index",width:b.width-8,emptyText:h.emptyText,value:"",events:[{change:e.onEnter,scope:e}],data:[{index:"",valueText:""},{index:"false",valueText:"false"},{index:"true",valueText:"true"}]});break;default:var j=[{enter:e.onEnter,scope:e}];e.autoEnterDelay!==!1&&j.push({key:e.onKey,scope:e}),d=new Fancy.StringField({renderTo:c.dom,label:!1,style:g,padding:!1,emptyText:h.emptyText,events:j})}switch(d.filterIndex=b.index,d.column=b,"date"!==a&&(d.el.css("padding-left","4px"),d.el.css("padding-top","0px")),a){case"checkbox":case"combo":case"date":break;default:d.setInputSize({width:b.width-8})}},onEnter:function(a,b,c){var d=this,e=a.filterIndex;if(c=c||{},d.intervalAutoEnter&&(clearInterval(d.intervalAutoEnter),d.intervalAutoEnter=!1),delete d.intervalAutoEnter,0===b.length)return d.filters[a.filterIndex]={},void d.updateStoreFilters();var f=d.processFilterValue(b,a.column.type),g=0,h=f.length;for(d.filters[e]={};h>g;g++){var i=f[g];d.filters[e][i.operator]=i.value,Fancy.apply(d.filters[e],c)}d.updateStoreFilters()},processFilterValue:function(a,b){for(var c,d,e={"<":!0,">":!0,"!":!0,"=":!0},f=0,g=3,h=[],i=a.split(","),j=0,k=i.length;k>j;j++){for(f=0,c="",d=i[j];g>f;f++)e[d[f]]&&(c+=d[f]);d=d.replace(new RegExp("^"+c),""),d.length<1||("number"===b&&(d=Number(d)),h.push({operator:c,value:d}))}return h},updateStoreFilters:function(){var a=this,b=a.widget,c=b.store;c.filters=a.filters,c.changeDataView(),b.update()},onColumnResize:function(a,b){var c,d=this,e=(d.widget,Fancy.get(b.cell)),f=b.width,g=e.select(".fancy-field");0===g.length||(2===g.length?(c=Fancy.getWidget(g.item(0).dom.id),c.setWidth((f-8)/2),c=Fancy.getWidget(g.item(1).dom.id),c.setWidth((f-8)/2)):(c=Fancy.getWidget(g.dom.id),c.setInputSize({width:f-8})))},onKey:function(a,b,c){var d=this;d.autoEnterTime||+new Date;c.keyCode!==Fancy.key.ENTER&&(d.autoEnterTime=+new Date,d.intervalAutoEnter||(d.intervalAutoEnter=setInterval(function(){var c=new Date;d.intervalAutoEnter&&c-d.autoEnterTime>d.autoEnterDelay&&(clearInterval(d.intervalAutoEnter),delete d.intervalAutoEnter,b=a.getValue(),d.onEnter(a,b))},200)))},onDateChange:function(a,b){var c,d,e,f=this,g=f.widget,h=a.format,i=g.store,j=a.dateField1.getDate(),k=a.dateField2.getDate(),l="Invalid Date"!==j.toString(),m="Invalid Date"!==k.toString(),n=i.remoteFilter;l&&m?(n!==!0?(d=Number(j),e=Number(k)):(d=Fancy.Date.format(j,h.edit),e=Fancy.Date.format(k,h.edit)),c=">"+d+",<"+e):l?(c=n!==!0?">"+Number(j):">"+Fancy.Date.format(j,h.edit),f.clearFilter(a.filterIndex,"<",!1)):m?(c=n!==!0?"<"+Number(k):"<"+Fancy.Date.format(j,h.edit),f.clearFilter(a.filterIndex,">",!1)):f.clearFilter(a.filterIndex),c&&f.onEnter(a,c,{type:"date",format:a.format})},clearFilter:function(a,b,c){var d=this;void 0===b?delete d.filters[a]:d.filters[a]&&delete d.filters[a][b],c!==!1&&d.updateStoreFilters()}});